{
  "hash": "f2e8003b831c0df52405a92a03cd93d3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'LAB: Linear Regression on Whiteside data (2)'\ndate: \"2025-03-18 15:11:07.247118\"\ndraft: false \n\nexecute:\n  echo: true\n  eval: true\n  collapse: true\n\n\nformat:\n  html:\n    output-file: lab-linear-regression-whiteside-2.html\n  pdf:\n    output-file: lab-linear-regression-whiteside-2.pdf\n\n\n---\n\n\n\n\n::: {layout=\"[80,20]\"}\n\n::: {#first-column}\n\n|                            |\n|:---------------------------|\n| {{< var curriculum >}}     |\n| {{< var university >}}     |\n| Ann√©e {{< var year >}}     |\n| {{< var homepage >}}       |\n| {{< var moodle >}}         |\n\n\n::: \n\n::: {#second-column}\n![](/images/UniversiteParis_monogramme_couleur_RVB.png){align=\"right\" style=\"size:50px;\" width=75}\n:::\n\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We will use the following packages. \n# If needed, install them : pak::pkg_install(). \nstopifnot(\n  require(\"MASS\"),\n  require(\"isotone\"),\n  require(\"magrittr\"),\n  require(\"lobstr\"),\n  require(\"ggforce\"),\n  require(\"patchwork\"), \n  require(\"gt\"),\n  require(\"glue\"),\n  require(\"skimr\"),\n  require(\"corrr\"),\n  require(\"GGally\"),\n  require(\"broom\"),\n  require(\"tidyverse\"),\n  require(\"ggfortify\"),\n  require(\"autoplotly\")\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(whiteside)\n```\n:::\n\n\n\n\n## Model comparison\n\n\n::: {.callout-note title='Question'} \n\nFor the Whiteside data, build a linear model where the covariates are the interactions of `Insul`  with powers of `Temp` (up to degree 5). \n\n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n\n \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_5 <- whiteside |>\n  mutate(feat=poly(Temp, degree=5, raw=T)) |>\n  select(-Temp) |>\n  rename_with(~ gsub('feat', 'Temp_', .), contains('feat')) %>%\n  lm(Gas ~ Insul*., data=.)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_lmm <- function(lmm){\n  lmm |> \n  tidy() |>\n  gt::gt() |>\n  gt::fmt_scientific(p.value) |>\n  gt::fmt_number(-p.value, decimals=2) |>\n  gt::tab_caption(glue(\"Formula: {deparse(lmm$call$formula)}\"))\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_5 |> \n  tidy_lmm()\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{lrrrr}\n\\toprule\nterm & estimate & std.error & statistic & p.value \\\\ \n\\midrule\\addlinespace[2.5pt]\n(Intercept) & 6.58 & 0.25 & 26.34 & 1.41 $\\times$ 10\\textsuperscript{-28} \\\\ \nInsulAfter & -1.75 & 0.32 & -5.40 & 2.57 $\\times$ 10\\textsuperscript{-6} \\\\ \nTemp\\_1 & -0.46 & 0.21 & -2.18 & 3.46 $\\times$ 10\\textsuperscript{-2} \\\\ \nTemp\\_2 & 0.18 & 0.21 & 0.88 & 3.83 $\\times$ 10\\textsuperscript{-1} \\\\ \nTemp\\_3 & -0.06 & 0.06 & -0.95 & 3.46 $\\times$ 10\\textsuperscript{-1} \\\\ \nTemp\\_4 & 0.01 & 0.01 & 0.94 & 3.50 $\\times$ 10\\textsuperscript{-1} \\\\ \nTemp\\_5 & 0.00 & 0.00 & -0.92 & 3.62 $\\times$ 10\\textsuperscript{-1} \\\\ \nInsulAfter:Temp\\_1 & 0.22 & 0.30 & 0.74 & 4.65 $\\times$ 10\\textsuperscript{-1} \\\\ \nInsulAfter:Temp\\_2 & -0.42 & 0.29 & -1.44 & 1.56 $\\times$ 10\\textsuperscript{-1} \\\\ \nInsulAfter:Temp\\_3 & 0.16 & 0.09 & 1.73 & 9.07 $\\times$ 10\\textsuperscript{-2} \\\\ \nInsulAfter:Temp\\_4 & -0.02 & 0.01 & -1.80 & 7.87 $\\times$ 10\\textsuperscript{-2} \\\\ \nInsulAfter:Temp\\_5 & 0.00 & 0.00 & 1.78 & 8.22 $\\times$ 10\\textsuperscript{-2} \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_5 |>\n  glance()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 12\n  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC\n      <dbl>         <dbl> <dbl>     <dbl>    <dbl> <dbl>  <dbl> <dbl> <dbl>\n1     0.945         0.932 0.305      69.1 4.80e-24    11  -6.28  38.6  64.9\n# i 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>\n```\n\n\n:::\n:::\n\n\n\n\n:::\n\n:::\n\n::: {.callout-note title='Question'} \n \nCompare model `Gas ~ Insul* poly(Temp, 5, raw=T)` with models `Gas ~ Insul + Temp` and `Gas ~ Insul * Temp`.\n\n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n \n::: {.callout-tip title='Solution'} \n \n \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlst_formulae <-  c('Gas ~ Insul + Temp', 'Gas ~ Insul * Temp', 'Gas ~ Insul* poly(Temp, 5, raw=T)') |>\n  map(as.formula)\n\nlst_models <- map(lst_formulae, \\(x) lm(x, data=whiteside))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlst_models |>\n  purrr::map_dfr(glance) |>\n  mutate(form=map_chr(lst_formulae,deparse)) |>\n  relocate(form) |>\n  select(1:7) |>\n  gt::gt() |>\n  gt::fmt_scientific(p.value) |>\n  gt::fmt_number(-p.value, decimals=2) |>\n  gt::fmt_integer(df)\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{lrrrrrr}\n\\toprule\nform & r.squared & adj.r.squared & sigma & statistic & p.value & df \\\\ \n\\midrule\\addlinespace[2.5pt]\nGas \\textasciitilde{} Insul + Temp & 0.91 & 0.91 & 0.36 & 267.11 & 2.09 $\\times$ 10\\textsuperscript{-28} & 2 \\\\ \nGas \\textasciitilde{} Insul * Temp & 0.93 & 0.92 & 0.32 & 222.33 & 1.23 $\\times$ 10\\textsuperscript{-29} & 3 \\\\ \nGas \\textasciitilde{} Insul * poly(Temp, 5, raw = T) & 0.95 & 0.93 & 0.31 & 69.12 & 4.80 $\\times$ 10\\textsuperscript{-24} & 11 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n:::\n\n::: {.callout-note title='Question'} \n \nComment the diagnostic plots for `Gas ~ Insul* poly(Temp, 5, raw=T)`\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n \n::: {.callout-tip title='Solution'} \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(lm_5) \n```\n\n::: {.cell-output-display}\n![](lab-linear-regression-whiteside-2_files/figure-pdf/unnamed-chunk-10-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n \n:::\n\n\n:::\n\n::: {.callout-note title='Question'} \n \nIn model defined by `Gas ~ Insul* poly(Temp, 5, raw=T)`, which coefficients are deemed to differ significantly from `0` (at level $99\\%$)?\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntbb_confint <- function(lmm, level=.95) {\n  lmm |>\n  confint(level=level) |>\n  as_tibble() |>\n  mutate(coeff=names(coefficients(lmm))) |>\n  relocate(coeff)   \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_5 |>\n  tbb_confint(level=.99) |>\n  gt::gt()  |> \n  gt::fmt_scientific(exp_style = \"e1\") |>\n  gt::tab_caption(deparse(formula(lm_5)))\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{lrr}\n\\toprule\ncoeff & 0.5 \\% & 99.5 \\% \\\\ \n\\midrule\\addlinespace[2.5pt]\n(Intercept) & 5.91e0 & 7.25e0 \\\\ \nInsulAfter & -2.62e0 & -8.77e-1 \\\\ \nTemp\\_1 & -1.03e0 & 1.08e-1 \\\\ \nTemp\\_2 & -3.74e-1 & 7.38e-1 \\\\ \nTemp\\_3 & -2.21e-1 & 1.05e-1 \\\\ \nTemp\\_4 & -1.25e-2 & 2.59e-2 \\\\ \nTemp\\_5 & -1.06e-3 & 5.19e-4 \\\\ \nInsulAfter:Temp\\_1 & -5.82e-1 & 1.02e0 \\\\ \nInsulAfter:Temp\\_2 & -1.20e0 & 3.62e-1 \\\\ \nInsulAfter:Temp\\_3 & -8.78e-2 & 4.03e-1 \\\\ \nInsulAfter:Temp\\_4 & -5.10e-2 & 1.01e-2 \\\\ \nInsulAfter:Temp\\_5 & -4.45e-4 & 2.18e-3 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_5 |>\n  tbb_confint(level=.95) |> \n  filter(! (`2.5 %` < 0 & 0 < `97.5 %`))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 x 3\n  coeff       `2.5 %` `97.5 %`\n  <chr>         <dbl>    <dbl>\n1 (Intercept)   6.07    7.08  \n2 InsulAfter   -2.40   -1.10  \n3 Temp_1       -0.885  -0.0350\n```\n\n\n:::\n:::\n\n\n\n\n\n:::\n\n:::\n\n::: {.callout-note title='Question'} \n\nPick the *best subset solution* \n \n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n\n\n\n::: {.cell}\n\n:::\n\n\n\n \n:::\n\n:::\n\n\n::: {.callout-note title='Question'} \n \nUse `stepAIC` from package `MASS` to explore the submodels of `Gas ~ Insul * poly(Temp, 5, raw=T)`.\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_5 <- lm(Gas ~ Insul * (Temp + I(Temp^2) + I(Temp^3) + I(Temp^4) + I(Temp^5)), whiteside)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- stepAIC(lm_5, trace=T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStart:  AIC=-122.36\nGas ~ Insul * (Temp + I(Temp^2) + I(Temp^3) + I(Temp^4) + I(Temp^5))\n\n                  Df Sum of Sq    RSS     AIC\n- Insul:Temp       1  0.050615 4.1542 -123.67\n<none>                         4.1036 -122.36\n- Insul:I(Temp^2)  1  0.194003 4.2976 -121.77\n- Insul:I(Temp^3)  1  0.279013 4.3826 -120.67\n- Insul:I(Temp^5)  1  0.295019 4.3986 -120.47\n- Insul:I(Temp^4)  1  0.302257 4.4059 -120.38\n\nStep:  AIC=-123.67\nGas ~ Insul + Temp + I(Temp^2) + I(Temp^3) + I(Temp^4) + I(Temp^5) + \n    Insul:I(Temp^2) + Insul:I(Temp^3) + Insul:I(Temp^4) + Insul:I(Temp^5)\n\n                  Df Sum of Sq    RSS     AIC\n<none>                         4.1542 -123.67\n- Insul:I(Temp^2)  1   0.18554 4.3398 -123.22\n- Insul:I(Temp^5)  1   0.24550 4.3997 -122.45\n- Insul:I(Temp^3)  1   0.24925 4.4035 -122.41\n- Insul:I(Temp^4)  1   0.25853 4.4128 -122.29\n- Temp             1   0.51565 4.6699 -119.12\n```\n\n\n:::\n:::\n\n\n\n\n\n:::\n \n:::\n\n\n## Penalized regression\n\n\n::: {.callout-note title='Question'} \n \n \n:::\n\n\n::: {.content-visible when-profile='solution'} \n\n::: {.callout-tip title='Solution'} \n \n \n::: \n \n:::\n\n## Robust regression\n\n::: {.callout-note title='Question'} \n \n \n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n \n:::\n\n:::\n\n\n## Shape constrained inference\n\n\n::: {.callout-note title='Question'} \n \n \n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngp_whiteside <- whiteside |>\n  group_by(Insul) |>\n  arrange(Temp, .by_group=T) \n  \nres <- gp_whiteside  |>\n  summarize(gpv=list(- gpava(z=Temp, y=-Gas, ties=\"secondary\")[[\"x\"]]), Temp = list(Temp)) |>\n  unnest(cols=c(gpv, Temp)) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngp_whiteside |>\n  bind_cols(res) |>\n  ggplot() +\n    aes(x=`Temp...2`, group=`Insul...1`) +\n    geom_point(aes(y=`Gas`, shape=`Insul...1`)) +\n    geom_step(aes(y=gpv, linetype=`Insul...1`)) +\n    geom_smooth(aes(y=Gas), formula='y ~ x', method=\"lm\", se=F)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNew names:\n* `Insul` -> `Insul...1`\n* `Temp` -> `Temp...2`\n* `Insul` -> `Insul...4`\n* `Temp` -> `Temp...6`\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-linear-regression-whiteside-2_files/figure-pdf/unnamed-chunk-18-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n:::\n\n\n::: {.callout-tip title='Solution'} \n \n \n:::\n\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{booktabs}\n\\usepackage{caption}\n\\usepackage{longtable}\n\\usepackage{colortbl}\n\\usepackage{array}\n\\usepackage{anyfontsize}\n\\usepackage{multirow}\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}