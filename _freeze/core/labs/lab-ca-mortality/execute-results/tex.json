{
  "hash": "16e52f810488f91abd599535a578bb37",
  "result": {
    "engine": "knitr",
    "markdown": "---\ndate: \"2025-03-16 11:04:32.883082\"\ntitle: \"LAB: Correspondance Analysis\"\n\n\nexecute:\n  echo: true\n  eval: true\n  collapse: true\n\nformat:\n  html:\n    output-file: lab-ca.html\n  pdf:\n    output-file: lab-ca.pdf\n\n\nengine: knitr\n---\n\n\n\n\n\n\n\n\n\n\n::: {layout=\"[80,20]\"}\n\n::: {#first-column}\n\n|                            |\n|:---------------------------|\n| {{< var curriculum >}}     |\n| {{< var university >}}     |\n| Année {{< var year >}}     |\n| {{< var homepage >}}       |\n| {{< var moodle >}}         |\n\n\n::: \n\n::: {#second-column}\n![](/images/UniversiteParis_monogramme_couleur_RVB.png){align=\"right\" style=\"size:50px;\" width=75}\n:::\n\n:::\n\n\n\n\n\n\nBesides the usual packages (`tidyverse`, ...),  we shall require \n`FactoMineR` and related packages.  \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nstopifnot(\n  require(FactoMineR),\n  require(factoextra),\n  require(FactoInvestigate)\n)\n```\n:::\n\n\n\n\n\n\n\n\nCorrespondence Analysis  \n=========================\n\n\n## The `mortality`  dataset\n\nThe goal is to investigate a possible link between age group and cause of death.\nWe work with dataset `mortality`  from package `FactoMineR`\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"mortality\", package = \"FactoMineR\")\n```\n:::\n\n\n```{.r .cell-code}\n#help(mortality)\n```\n\n\n\n\n\n\n>  A data frame with 62 rows (the different causes of death) and 18 columns. Each column corresponds to an age interval (15-24, 25-34, 35-44, 45-54, 55-64, 65-74, 75-84, 85-94, 95 and more) in a year. The 9 first columns correspond to data in 1979 and the 9 last columns to data in 2006. In each cell, the counts of deaths for a cause of death in an age interval (in a year) is given.\n\nSource\n: [Centre d'épidemiologie sur les causes  de décès médicales](https://www.cepidc.inserm.fr)\n\nSee also EuroStat:\n\n- [Causes of death (hlth_cdeath)  Reference Metadata in Single Integrated Metadata Structure (SIMS)](https://ec.europa.eu/eurostat/cache/metadata/en/hlth_cdeath_sims.htm)\n- \n\n::: {.callout-note}\n\n### Question\n\nRead the documentation of the `mortality` dataset. Is this a sample? an aggregated  dataset?\n\nIf you consider `mortality` as an agregated dataset, can you figure out the organization  of the sample `mortality` was built from?  \n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n::: {.callout-tip title='Solution'} \n \n \nThe `mortality` dataset is an *aggregated* dataset. It has been built from two samples. \nEach sample was built from the collection of *death certificates* from one calendar \nyear in France (years 1999 and 2006). From each death certificate, two categorical pieces of information were extracted: *age group* of the deceased and a *cause of death*. Each sample \nwas then grouped by *age group*  and *cause of death* and counts were computed. This defines a\ntwo-ways *contingency table* in *long* form. The contingency table in *wide* form is obtained by pivoting: pick column names from column *age group* and values from counts. Column *cause of depth* provide row names.\n\nThe final form of the dataset is obtained by concatenating the two contingency tables along the second axis. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality |> \n    select(ends_with('(06)')) |> \n    gt::gt()\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{rrrrrrrrr}\n\\toprule\n15-24 (06) & 25-34 (06) & 35-44 (06) & 45-54 (06) & 55-64 (06) & 65-74 (06) & 75-84 (06) & 85-94 (06) & 95 and more (06) \\\\ \n\\midrule\\addlinespace[2.5pt]\n54 & 109 & 141 & 135 & 89 & 97 & 196 & 159 & 27 \\\\ \n18 & 77 & 72 & 15 & 4 & 2 & 1 & 0 & 0 \\\\ \n14 & 79 & 403 & 977 & 786 & 397 & 245 & 52 & 3 \\\\ \n12 & 11 & 30 & 81 & 99 & 138 & 290 & 280 & 52 \\\\ \n20 & 22 & 43 & 94 & 159 & 259 & 642 & 670 & 213 \\\\ \n35 & 75 & 311 & 902 & 1575 & 3719 & 12172 & 11385 & 2464 \\\\ \n1 & 35 & 453 & 1737 & 2369 & 1767 & 1096 & 199 & 12 \\\\ \n6 & 29 & 23 & 1 & 0 & 0 & 0 & 0 & 0 \\\\ \n31 & 31 & 30 & 49 & 37 & 30 & 43 & 14 & 0 \\\\ \n4 & 8 & 8 & 8 & 3 & 9 & 8 & 0 & 0 \\\\ \n8 & 30 & 101 & 338 & 823 & 1881 & 4222 & 3042 & 527 \\\\ \n39 & 47 & 76 & 91 & 82 & 47 & 41 & 21 & 4 \\\\ \n50 & 81 & 144 & 326 & 397 & 551 & 1532 & 1660 & 467 \\\\ \n3 & 1 & 13 & 38 & 48 & 99 & 264 & 244 & 55 \\\\ \n52 & 83 & 65 & 63 & 42 & 27 & 21 & 6 & 0 \\\\ \n1 & 1 & 7 & 13 & 35 & 104 & 500 & 807 & 322 \\\\ \n3 & 1 & 3 & 2 & 5 & 7 & 31 & 49 & 14 \\\\ \n4 & 60 & 474 & 1688 & 2974 & 5486 & 13739 & 11882 & 2499 \\\\ \n3 & 10 & 35 & 106 & 266 & 655 & 2432 & 2454 & 545 \\\\ \n9 & 43 & 127 & 176 & 303 & 319 & 368 & 187 & 15 \\\\ \n111 & 148 & 285 & 598 & 1351 & 2716 & 4736 & 2225 & 241 \\\\ \n4 & 12 & 63 & 302 & 603 & 863 & 1054 & 402 & 38 \\\\ \n0 & 10 & 52 & 140 & 313 & 552 & 796 & 410 & 50 \\\\ \n0 & 5 & 26 & 183 & 525 & 1037 & 1849 & 960 & 104 \\\\ \n3 & 91 & 588 & 1447 & 2198 & 2369 & 3010 & 1641 & 284 \\\\ \n0 & 13 & 75 & 156 & 130 & 124 & 148 & 53 & 4 \\\\ \n5 & 8 & 53 & 226 & 470 & 755 & 1095 & 451 & 41 \\\\ \n0 & 38 & 681 & 4059 & 7285 & 8026 & 7678 & 1869 & 128 \\\\ \n6 & 17 & 103 & 930 & 1261 & 879 & 660 & 224 & 36 \\\\ \n10 & 22 & 119 & 489 & 1295 & 2228 & 2485 & 736 & 67 \\\\ \n0 & 7 & 44 & 518 & 920 & 1013 & 970 & 342 & 23 \\\\ \n4 & 17 & 135 & 538 & 1421 & 2572 & 4641 & 2486 & 346 \\\\ \n3 & 5 & 101 & 586 & 1376 & 2146 & 2754 & 1163 & 129 \\\\ \n1 & 0 & 1 & 74 & 509 & 1634 & 3982 & 2449 & 287 \\\\ \n3 & 15 & 60 & 255 & 656 & 954 & 1492 & 746 & 85 \\\\ \n3 & 30 & 107 & 360 & 649 & 1061 & 1648 & 823 & 82 \\\\ \n5 & 4 & 8 & 11 & 15 & 28 & 33 & 15 & 0 \\\\ \n8 & 0 & 1 & 1 & 0 & 4 & 2 & 0 & 0 \\\\ \n238 & 346 & 524 & 840 & 979 & 1280 & 3116 & 3880 & 1229 \\\\ \n2 & 1 & 26 & 154 & 446 & 1253 & 3058 & 2248 & 463 \\\\ \n30 & 31 & 42 & 95 & 113 & 49 & 50 & 36 & 1 \\\\ \n28 & 57 & 224 & 604 & 946 & 1842 & 4912 & 4844 & 1148 \\\\ \n167 & 214 & 455 & 837 & 1334 & 2884 & 10105 & 9267 & 1572 \\\\ \n11 & 16 & 28 & 66 & 155 & 369 & 1061 & 966 & 238 \\\\ \n56 & 65 & 90 & 315 & 411 & 750 & 2072 & 2767 & 1109 \\\\ \n14 & 28 & 42 & 90 & 132 & 288 & 631 & 424 & 59 \\\\ \n1 & 1 & 7 & 12 & 46 & 170 & 655 & 762 & 181 \\\\ \n75 & 126 & 331 & 921 & 1685 & 3801 & 12888 & 17627 & 5738 \\\\ \n42 & 126 & 346 & 752 & 1077 & 1746 & 4943 & 7920 & 4253 \\\\ \n43 & 84 & 303 & 833 & 1826 & 3874 & 10855 & 10389 & 2512 \\\\ \n32 & 32 & 95 & 260 & 537 & 1009 & 2578 & 2371 & 507 \\\\ \n137 & 234 & 609 & 2346 & 4248 & 5664 & 7943 & 3833 & 533 \\\\ \n19 & 39 & 122 & 266 & 374 & 794 & 3731 & 6029 & 2037 \\\\ \n32 & 32 & 70 & 236 & 541 & 1437 & 4265 & 4243 & 1286 \\\\ \n39 & 45 & 141 & 300 & 564 & 1010 & 2192 & 1713 & 318 \\\\ \n13 & 17 & 79 & 211 & 296 & 721 & 2890 & 4014 & 1402 \\\\ \n0 & 1 & 0 & 4 & 14 & 99 & 231 & 176 & 54 \\\\ \n1214 & 785 & 646 & 599 & 443 & 362 & 454 & 137 & 8 \\\\ \n522 & 1141 & 1972 & 2293 & 1524 & 1211 & 1223 & 454 & 45 \\\\ \n3 & 5 & 11 & 23 & 51 & 82 & 314 & 215 & 23 \\\\ \n227 & 476 & 928 & 1517 & 1585 & 1487 & 2446 & 2298 & 872 \\\\ \n0 & 9 & 76 & 117 & 94 & 143 & 224 & 61 & 6 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n## Elementary statistics and table wrangling\n\n\nBefore proceeding to Correspondence  Analysis (CA), let us draw some elementary plots. \n\n::: {.callout-note  title=\"Question\"}\n\n- Start by partially *pivoting* `mortality`, so as to obtain a tibble with columns `cause`, `year`, while keeping all columns named after age groups (tidy up the data so as to obtain a tibble in partially long format). \n- Use `rowwise()` and `sum(c_cross())` so as to compute the total number of deaths per `year` and `cause`  in column `total`. This allows to mimic `rowSums()` inside a pipeline. Column `grand_total` is computed using a *window* function over grouping by `cause`. \n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality_long <- mortality |> \n  as_tibble() |> \n  mutate(cause = rownames(mortality)) |> \n  mutate(cause=as_factor(cause)) |> \n  relocate(cause) |> \n  pivot_longer(\n    cols=-cause,\n    cols_vary=\"slowest\",\n    names_to=c(\".value\", \"year\"),\n    names_pattern=\"([\\\\w\\\\- ]*) \\\\(([0-9]{2})\\\\)\"\n  )  |> \n  mutate(year=ifelse(year=='06', 2006, 1979)) |> \n  rowwise() |> \n  mutate(total=sum(c_across(-c(cause, year)))) |> \n  group_by(cause) |> \n  mutate(grand_total = sum(total)) |> \n  ungroup()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality_long |>\n slice_sample(n=10) |>\n gt::gt() |>\n gt::tab_caption(\"A sample of lines of Mortality table in long form\")\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{crrrrrrrrrrrr}\n\\toprule\ncause & year & 15-24 & 25-34 & 35-44 & 45-54 & 55-64 & 65-74 & 75-84 & 85-94 & 95 and more & total & grand\\_total \\\\ \n\\midrule\\addlinespace[2.5pt]\nAccidental poisoning & 2006 & 54 & 109 & 141 & 135 & 89 & 97 & 196 & 159 & 27 & 1007 & 1510 \\\\ \nMalignant tumour of the cervix & 2006 & 0 & 13 & 75 & 156 & 130 & 124 & 148 & 53 & 4 & 703 & 1527 \\\\ \nTuberculosis & 1979 & 8 & 38 & 84 & 234 & 314 & 605 & 578 & 201 & 8 & 2070 & 2797 \\\\ \nOther diseases of the nervous system and sensory organs & 2006 & 167 & 214 & 455 & 837 & 1334 & 2884 & 10105 & 9267 & 1572 & 26835 & 38891 \\\\ \nOther endocrinological, metabolic and nutritional conditions  & 2006 & 56 & 65 & 90 & 315 & 411 & 750 & 2072 & 2767 & 1109 & 7635 & 13665 \\\\ \nMalignant tumour of the bladder & 2006 & 0 & 5 & 26 & 183 & 525 & 1037 & 1849 & 960 & 104 & 4689 & 8322 \\\\ \nPneumonia & 2006 & 13 & 17 & 79 & 211 & 296 & 721 & 2890 & 4014 & 1402 & 9643 & 14700 \\\\ \nAddiction to prescription medication & 2006 & 18 & 77 & 72 & 15 & 4 & 2 & 1 & 0 & 0 & 189 & 222 \\\\ \nAlcohol abuse and alcohol-related psychosis & 2006 & 14 & 79 & 403 & 977 & 786 & 397 & 245 & 52 & 3 & 2956 & 6327 \\\\ \nEvents of undetermined intention & 1979 & 297 & 382 & 296 & 329 & 239 & 279 & 221 & 66 & 1 & 2110 & 2558 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::\n\n\n::: {.callout-note title='Question'} \n \nBuild a bar plot to display the importance of causes of deaths in France in years 1979 and 2006\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nth <- theme_get()\n(\nmortality_long |> \n  ggplot() +\n  scale_fill_discrete() +\n  aes(x=fct_reorder(cause, desc(grand_total)), \n      y=total, \n      fill=as_factor(year), \n      label=cause) +\n  geom_col(position=position_dodge()) +\n  theme(\n    legend.position=\"none\",\n    axis.text.x=element_blank(), #remove x axis labels\n    axis.ticks.x=element_blank(), #remove x axis ticks\n  ) +\n  labs(\n    title = \"Causes of death, France, 1979, 2006\",\n    subtitle= \"Raw counts\"\n  ) +\n  xlab(label=NULL)\n) |>\n  plotly::ggplotly()  \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPhantomJS not found. You can install it with webshot::install_phantomjs(). If it is installed, please make sure the phantomjs executable can be found via the PATH variable.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-9-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\noth <- theme_set(th)\n```\n:::\n\n\n\n\n\n\n:::\n:::\n\n\n::: {.callout-note title='Question'} \n \nCompute and display the total number of deaths in France in years 1979 and 2006.\n\n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title='Solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality_long |> \n  group_by(year) |> \n  summarise(total_deaths = sum(total)) |>\n  gt::gt() |>\n  gt::cols_label(\n    year= \"Year\", \n    total_deaths = \"#Deaths\") |>\n  gt::tab_caption(\"Mortality in France\")\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{rr}\n\\toprule\nYear & \\#Deaths \\\\ \n\\midrule\\addlinespace[2.5pt]\n1979 & 529974 \\\\ \n2006 & 510921 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n\n::: \n:::\n\n\n\n\n\n\n::: {.callout-note title=\"Question\"}\n\nCompute the marginal counts for each year (1979, 2006). Compare. \n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n \nCounts have already been computed above. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality_long |> \n  select(cause, year, total) |> \n  pivot_wider(\n    id_cols=c(cause), \n    names_from = year, \n    values_from = total) |> \n  gt::gt()\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{crr}\n\\toprule\ncause & 1979 & 2006 \\\\ \n\\midrule\\addlinespace[2.5pt]\nAccidental poisoning & 503 & 1007 \\\\ \nAddiction to prescription medication & 33 & 189 \\\\ \nAlcohol abuse and alcohol-related psychosis & 3371 & 2956 \\\\ \nAsthma & 1495 & 993 \\\\ \nBlood and hematopoietic disorders & 2177 & 2122 \\\\ \nCerebrovascular disease & 66157 & 32638 \\\\ \nChronic liver disease & 15927 & 7669 \\\\ \nComplications in pregnancy and childbirth & 91 & 59 \\\\ \nCongenital defects of the circulatory system & 275 & 265 \\\\ \nCongenital defects of the nervous system & 61 & 48 \\\\ \nDiabetes & 7111 & 10972 \\\\ \nEvents of undetermined intention & 2110 & 448 \\\\ \nFalls & 12503 & 5208 \\\\ \nGastroduodenal ulcer & 2216 & 765 \\\\ \nHomicides & 516 & 359 \\\\ \nInfections of the skin and sub-cutaneous cellular tissue & 1649 & 1790 \\\\ \nInfluenza & 1051 & 115 \\\\ \nIschemic cardiomyopathy & 49532 & 38806 \\\\ \nKidney and urethra disease & 7107 & 6506 \\\\ \nMalignant melanoma & 658 & 1547 \\\\ \nMalignant neplasm of the lymphatic and hematopoietic tissues  & 7589 & 12411 \\\\ \nMalignant ovarian tumour & 2320 & 3341 \\\\ \nMalignant tumour in other parts of the uterus & 2940 & 2323 \\\\ \nMalignant tumour of the bladder & 3633 & 4689 \\\\ \nMalignant tumour of the breast & 8605 & 11631 \\\\ \nMalignant tumour of the cervix & 824 & 703 \\\\ \nMalignant tumour of the kidney & 2101 & 3104 \\\\ \nMalignant tumour of the larynx, trachea, bronchus and lungs & 20840 & 29764 \\\\ \nMalignant tumour of the lip, pharynx and mouth & 5606 & 4116 \\\\ \nMalignant tumour of the liver and intrahepatic biliary tract & 4001 & 7451 \\\\ \nMalignant tumour of the oesophogus & 5430 & 3837 \\\\ \nMalignant tumour of the of the colon & 9593 & 12160 \\\\ \nMalignant tumour of the of the pancreas & 4588 & 8263 \\\\ \nMalignant tumour of the prostate & 6577 & 8937 \\\\ \nMalignant tumour of the rectum and anus & 4980 & 4266 \\\\ \nMalignant tumour of the stomach & 9020 & 4763 \\\\ \nMeningitis  & 362 & 119 \\\\ \nMeningococal disease & 44 & 16 \\\\ \nOther accidents & 10921 & 12432 \\\\ \nOther chronic respiritory illnesses & 9680 & 7651 \\\\ \nOther congenital defects and chromosomal abnormalities  & 145 & 447 \\\\ \nOther digestive conditions & 18092 & 14605 \\\\ \nOther diseases of the nervous system and sensory organs & 12056 & 26835 \\\\ \nOther diseases of the osteo-articular system + muscles and connecting tissue & 1025 & 2910 \\\\ \nOther endocrinological, metabolic and nutritional conditions  & 6030 & 7635 \\\\ \nOther external injury and poisoning  & 1023 & 1708 \\\\ \nOther genito-urinary diseases  & 2552 & 1835 \\\\ \nOther heart disease & 54105 & 43192 \\\\ \nOther ill-defined symptoms and conditions & 17125 & 21205 \\\\ \nOther illnesses relating to circulation  & 31218 & 30719 \\\\ \nOther infectious diseases and parasites & 4045 & 7421 \\\\ \nOther malignent tumours & 23262 & 25547 \\\\ \nOther psychological and behavioural disorders  & 3749 & 13411 \\\\ \nOther respiratory ailments & 14197 & 12142 \\\\ \nOther tumours & 4077 & 6322 \\\\ \nPneumonia & 5057 & 9643 \\\\ \nRhumatoid arthritis and osteoarthritis & 705 & 579 \\\\ \nRoad accidents & 10607 & 4648 \\\\ \nSuicides & 9952 & 10385 \\\\ \nTuberculosis & 2070 & 727 \\\\ \nUnknown or unspecified causes & 14356 & 11836 \\\\ \nViral hepatitis & 329 & 730 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n \n:::\n\n:::::\n\n\n\n\n## Correspondance Analysis\n\n\n::: {.callout-important}\n\n### CA executive summary\n\n- Start from a 2-way contingency table $X$ with $\\sum_{i,j} X_{i,j}=N$\n- Normalize $P = \\frac{1}{N}X$ (_correspondance matrix_)\n- Let $r$ (resp. $c$) be the row (resp. column) wise sums vector\n- Let $D_r=\\text{diag}(r)$ denote the diagonal matrix with row sums of $P$ as coefficients\n- Let $D_c=\\text{diag}(c)$ denote the diagonal matrix with column sums of $P$ as coefficients\n\n\n+ The _row profiles matrix_ is $D_r^{-1} \\times P$\n+ The _standardized residuals matrix_ is  $S = D_r^{-1/2} \\times \\left(P - r c^T\\right) \\times D_c^{-1/2}$\n\nCA consists in computing the SVD of the standardized residuals matrix $S =  U  \\times D \\times V^T$\n\nFrom the SVD, we get\n- $D_r^{-1/2} \\times U$ *standardized coordinates of rows*\n- $D_c^{-1/2} \\times V$ *standardized coordinates of columns*\n- $D_r^{-1/2} \\times U \\times D$ *principal coordinates of rows*\n- $D_c^{-1/2} \\times V \\times D$ *principal coordinates of columns*\n- Squared singular values: the principal *inertia*\n\n\nWhen calling `svd(.)`, the argument should be\n$$D_r^{1/2}\\times \\left(D_r^{-1} \\times P \\times D_c^{-1}- \\mathbf{I}\\times \\mathbf{I}^T  \\right)\\times D_c^{1/2}$$\n\n\n:::\n\n\n::: {.callout-important}\n\n\n### CA and extended SVD\n\nAs\n$$D_r^{-1} \\times P \\times D_c^{-1} - \\mathbf{I}\\mathbf{I}^T = (D_r^{-1/2} \\times U)\\times D \\times (D_c^{-1/2}\\times V)^T$$\n\n$(D_r^{-1/2} \\times U)\\times D \\times (D_c^{-1/2}\\times V)^T$ is the _extended SVD_ of\n$$D_r^{-1} \\times P \\times D_c^{-1} - \\mathbf{I}\\mathbf{I}^T$$\nwith respect to $D_r$ and $D_c$\n\n\n:::\n\n::: {.callout-note}\n\n### Question\n\nPerform CA on the two contingency tables. \n\n:::\n\n::: {.callout-tip}\n\nYou may use `FactoMineR::CA()`. It is interesting to compute the correspondence analysis in your own way, by preparing the matrix that is handled to `svd()` and returning \na named list containing all relevant information. \n\n> Do the Jedi and Sith build their own light sabers? Jedi do. It's a key part of the religion to have a kyber crystal close to you, to build the saber through the power of the force creating a blade unique and in tune with them\n\n\n\n\n\n\n{{< fa jedi >}}\n\n\n\n\n\n\n\n\n\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlst_ca <- list()\n\nfor (y in c('79', '06')) {\n  lst_ca[[y]] <- mortality |> \n    select(ends_with(glue('({y})'))) |> \n    FactoMineR::CA(ncp=8, graph = F)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlst <- map(c('79', '06'), \n             \\(x) select(mortality, ends_with(glue('({x})'))) |>\n             FactoMineR::CA(ncp=8, graph = F)\n           )\n```\n:::\n\n\n\n\n\n\n\n:::\n\n:::::\n\n::: {.callout-note}\n\n### Question\n\nIf you did use `FactoMineR::CA()`, explain the organization of the result.\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n \nThe result of `FactoMineR::CA(...)` is a named and nested list with five elements:\n\n`eig`\n: a matrix/array containing enough information to build a screeplot.\n\n`call`\n: a list of 9, containing the call to `CA()`, an object of type `language`, telling (in principle) the user how `CA()` was called. However, this is a *quoted expression*. Here we need to guess the value of `y` in the calling environment understand what's going on. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlst_ca[[1]]$call$call\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFactoMineR::CA(X = select(mortality, ends_with(glue(\"({y})\"))), \n    ncp = 8, graph = F)\n```\n\n\n:::\n:::\n\n\n\n\n\nElement `call` also contains the table margin distributions `marge.col` and `marge.row`. The truncation rank `ncp` (number of components) can be assigned before computing the SVD (default value is 5). Element $X$ stores the contingency table that was effectively used for computing Correpondance Analysis. \n\n`row`\n: Information gathered from SVD to facilitate row profiles analysis. \n\n`col`\n: a list structured in the same way as element `row`. Used for column profiles analysis\n\n`svd`\n: a list of 3, just as the resuld of `svd()` containing the singular values, the left and right singular vectors of matrix $...$\n\n:::\n\n::: {.callout-warning}\n\nIn principle, all relevant information can be gathered from components `svd`, `call.marge.row`, and `call.marge.col`. \n\n:::\n\n:::::\n\n\n## Screeplots\n\n\n::: {.callout-note}\n\n### Question\n\nDraw screeplots. Why are they useful? Comment briefly. \n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nca_79 <- lst_ca[[1]]\n\nca_79$eig |> \n  as_tibble() |> \n  mutate(across(where(is.numeric), ~ round(.x, digits=2))) |> \n  gt::gt()\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{rrr}\n\\toprule\neigenvalue & percentage of variance & cumulative percentage of variance \\\\ \n\\midrule\\addlinespace[2.5pt]\n0.29 & 61.00 & 61.00 \\\\ \n0.14 & 28.98 & 89.98 \\\\ \n0.03 & 6.13 & 96.12 \\\\ \n0.01 & 2.86 & 98.98 \\\\ \n0.00 & 0.73 & 99.70 \\\\ \n0.00 & 0.17 & 99.88 \\\\ \n0.00 & 0.09 & 99.97 \\\\ \n0.00 & 0.03 & 100.00 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n \n### Screeplot \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nca_79$eig |> \n  as_tibble() |> \n  rownames_to_column(var=\"PC\") |> \n  rename(percent=eigenvalue, cumulative=`cumulative percentage of variance`) |> \n  ggplot() + \n  aes(x=PC, y=percent, label=round(cumulative,2)) +   # <3>\n  geom_text(angle=45, vjust=-1, hjust=-0.1) + \n  geom_col(fill=NA, colour=\"black\") + # <2>\n  ylab(\"Squared singular values\") +\n  ylim(c(0, .4)) +\n  labs(\n    title=\"Screeplot for CA\",\n    subtitle = \"Mortality 1979: Age Group versus Causes of Death\"\n  )\n```\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-16-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n\n:::::\n\n## Row profiles analysis\n\n\n::: {.callout-note}\n\n### Question \n\nPerform row profiles analysis.\n\nWhat are the classical plots? How can you build them from the output of `FactoMiner::CA`? \n\nBuild the table of row contributions (the so-called $cos^2$)\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n\nAttribute `row` of objects of class `CA` (exported from `FactoMineR`) is the starting point of any \nrow profiles analysis. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nca_79_row <- ca_79$row\n```\n:::\n\n\n\n\n\n\nAttribute `row` is a named list made of $4$ components. \n:::\n\n\n::: {.callout-tip title='Solution'} \n  \n`coord`\n: a matrix with named rows and columns. The number of rows of `coord` matches the number of rows of the contingency table (here, the number of possible death causes). The number of columns matches the rank of the truncated SVD that underlies Correspondance Analysis. Here it is $5$ which also the rank of the standardized contingency table.\n\n> The row principal coordinates are the principal coordinates of each row profile in terms of the principal component. \n\nThe columns of `coord` are pairwise orthogonal in the inner product space defined by `diag(call$marge.row)` (which embodies the marginal probabilities of the so-called causes of deaths)\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx <- ca_79$row$coord\nr <- ca_79$call$marge.row\n\nA <- round(t(x) %*% diag(r) %*% x, 2)\n\nis_diagonal <- function (A, tol=1e-2){\n  norm(diag(diag(A))-A, type='F') <= tol\n}\n\n# We expect A to be diagonal\nis_diagonal(A)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::\n\n\n\n\n\n\nWe can recover `row$coord` from the left singular vectors and the singular values:\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith(ca_79,   \n  norm(row$coord - with(svd, U %*% diag(vs[1:ca_79$call$ncp])), 'F')\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprep_rows <- ca_79_row$coord |> \n  as_tibble() |> \n  mutate(name= rownames(ca_79_row$coord)) |> \n  relocate(name) |> \n  mutate(prop=r, inertia=ca_79_row$inertia) \n\n\n\nprep_rows |> \n  mutate(across(where(is.numeric), \\(x) round(x,2))) |> \n  gt::gt()\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{lrrrrrrrrrr}\n\\toprule\nname & Dim 1 & Dim 2 & Dim 3 & Dim 4 & Dim 5 & Dim 6 & Dim 7 & Dim 8 & prop & inertia \\\\ \n\\midrule\\addlinespace[2.5pt]\nAccidental poisoning & 1.53 & 0.52 & 0.04 & -0.17 & 0.01 & -0.03 & -0.01 & -0.05 & 0.00 & 0.00 \\\\ \nAddiction to prescription medication & 1.75 & 0.44 & -0.12 & 0.27 & -0.12 & -0.24 & 0.19 & 0.22 & 0.00 & 0.00 \\\\ \nAlcohol abuse and alcohol-related psychosis & 0.65 & -0.74 & 0.44 & -0.08 & -0.17 & 0.09 & 0.02 & -0.02 & 0.01 & 0.01 \\\\ \nAsthma & -0.01 & -0.10 & -0.12 & -0.05 & 0.02 & 0.00 & 0.05 & 0.03 & 0.00 & 0.00 \\\\ \nBlood and hematopoietic disorders & -0.08 & 0.07 & -0.07 & -0.05 & -0.04 & -0.02 & -0.01 & 0.03 & 0.00 & 0.00 \\\\ \nCerebrovascular disease & -0.32 & 0.17 & -0.06 & -0.04 & -0.06 & -0.01 & 0.00 & 0.00 & 0.12 & 0.02 \\\\ \nChronic liver disease & 0.49 & -0.83 & 0.30 & 0.09 & -0.08 & 0.04 & -0.01 & -0.01 & 0.03 & 0.03 \\\\ \nComplications in pregnancy and childbirth & 3.53 & 1.80 & 0.28 & -2.09 & 0.99 & -0.77 & 0.15 & 0.06 & 0.00 & 0.00 \\\\ \nCongenital defects of the circulatory system & 1.94 & 0.54 & 0.01 & -0.10 & 0.11 & -0.01 & -0.08 & 0.11 & 0.00 & 0.00 \\\\ \nCongenital defects of the nervous system & 2.36 & 0.98 & -0.23 & 0.47 & -0.07 & -0.38 & 0.23 & -0.07 & 0.00 & 0.00 \\\\ \nDiabetes & -0.21 & -0.05 & -0.24 & -0.07 & 0.02 & 0.02 & 0.03 & 0.01 & 0.01 & 0.00 \\\\ \nEvents of undetermined intention & 1.71 & 0.35 & 0.24 & -0.46 & 0.05 & -0.03 & 0.01 & -0.01 & 0.00 & 0.01 \\\\ \nFalls & -0.34 & 0.49 & 0.27 & 0.07 & -0.02 & -0.05 & -0.05 & -0.02 & 0.02 & 0.01 \\\\ \nGastroduodenal ulcer & -0.11 & -0.14 & -0.08 & -0.03 & -0.03 & 0.01 & 0.01 & -0.01 & 0.00 & 0.00 \\\\ \nHomicides & 2.19 & 0.62 & 0.35 & -0.72 & 0.02 & 0.22 & -0.18 & 0.08 & 0.00 & 0.01 \\\\ \nInfections of the skin and sub-cutaneous cellular tissue & -0.41 & 0.40 & 0.11 & 0.02 & -0.06 & -0.03 & -0.01 & -0.02 & 0.00 & 0.00 \\\\ \nInfluenza & -0.41 & 0.51 & 0.28 & 0.10 & 0.06 & 0.02 & -0.02 & -0.02 & 0.00 & 0.00 \\\\ \nIschemic cardiomyopathy & -0.14 & -0.18 & -0.17 & -0.02 & 0.02 & 0.02 & 0.01 & -0.01 & 0.09 & 0.01 \\\\ \nKidney and urethra disease & -0.33 & 0.23 & 0.00 & -0.02 & -0.04 & -0.01 & -0.01 & 0.02 & 0.01 & 0.00 \\\\ \nMalignant melanoma & 0.63 & -0.34 & 0.25 & -0.32 & 0.06 & 0.07 & -0.06 & 0.02 & 0.00 & 0.00 \\\\ \nMalignant neplasm of the lymphatic and hematopoietic tissues  & 0.33 & -0.18 & -0.10 & -0.11 & 0.07 & 0.02 & 0.02 & -0.03 & 0.01 & 0.00 \\\\ \nMalignant ovarian tumour & 0.28 & -0.59 & 0.07 & 0.09 & -0.01 & -0.03 & 0.01 & -0.01 & 0.00 & 0.00 \\\\ \nMalignant tumour in other parts of the uterus & 0.08 & -0.41 & 0.01 & 0.06 & 0.01 & 0.00 & -0.01 & 0.05 & 0.01 & 0.00 \\\\ \nMalignant tumour of the bladder & -0.13 & -0.25 & -0.23 & 0.01 & 0.08 & 0.01 & 0.00 & 0.02 & 0.01 & 0.00 \\\\ \nMalignant tumour of the breast & 0.21 & -0.49 & 0.17 & 0.03 & -0.06 & 0.03 & -0.02 & 0.02 & 0.02 & 0.01 \\\\ \nMalignant tumour of the cervix & 0.42 & -0.60 & 0.29 & -0.07 & -0.16 & 0.16 & -0.07 & 0.05 & 0.00 & 0.00 \\\\ \nMalignant tumour of the kidney & 0.07 & -0.45 & -0.10 & 0.07 & 0.11 & -0.02 & -0.03 & 0.01 & 0.00 & 0.00 \\\\ \nMalignant tumour of the larynx, trachea, bronchus and lungs & 0.21 & -0.69 & -0.01 & 0.14 & 0.08 & -0.04 & -0.01 & -0.01 & 0.04 & 0.02 \\\\ \nMalignant tumour of the lip, pharynx and mouth & 0.41 & -0.82 & 0.31 & 0.21 & -0.16 & -0.07 & 0.09 & 0.00 & 0.01 & 0.01 \\\\ \nMalignant tumour of the liver and intrahepatic biliary tract & 0.06 & -0.44 & -0.13 & 0.05 & 0.13 & -0.05 & -0.02 & 0.01 & 0.01 & 0.00 \\\\ \nMalignant tumour of the oesophogus & 0.21 & -0.69 & 0.07 & 0.17 & 0.01 & -0.06 & 0.02 & 0.03 & 0.01 & 0.01 \\\\ \nMalignant tumour of the of the colon & -0.13 & -0.18 & -0.17 & -0.01 & 0.03 & 0.00 & 0.00 & 0.00 & 0.02 & 0.00 \\\\ \nMalignant tumour of the of the pancreas & -0.01 & -0.37 & -0.15 & 0.04 & 0.10 & 0.02 & -0.04 & 0.01 & 0.01 & 0.00 \\\\ \nMalignant tumour of the prostate & -0.29 & -0.01 & -0.35 & -0.09 & 0.03 & 0.05 & 0.03 & -0.01 & 0.01 & 0.00 \\\\ \nMalignant tumour of the rectum and anus & -0.08 & -0.27 & -0.16 & 0.01 & 0.09 & 0.00 & -0.02 & -0.02 & 0.01 & 0.00 \\\\ \nMalignant tumour of the stomach & -0.12 & -0.21 & -0.19 & -0.02 & 0.05 & 0.02 & -0.01 & 0.01 & 0.02 & 0.00 \\\\ \nMeningitis  & 0.63 & -0.22 & 0.02 & -0.05 & 0.03 & 0.08 & -0.12 & 0.04 & 0.00 & 0.00 \\\\ \nMeningococal disease & 1.93 & 0.72 & -0.55 & 0.77 & -0.09 & 0.08 & -0.02 & 0.05 & 0.00 & 0.00 \\\\ \nOther accidents & 1.18 & 0.30 & 0.01 & -0.02 & -0.02 & 0.00 & 0.01 & -0.01 & 0.02 & 0.03 \\\\ \nOther chronic respiritory illnesses & -0.27 & 0.06 & -0.11 & -0.01 & 0.01 & 0.01 & 0.01 & 0.01 & 0.02 & 0.00 \\\\ \nOther congenital defects and chromosomal abnormalities  & 1.09 & 0.19 & 0.04 & -0.29 & 0.13 & -0.27 & 0.12 & 0.01 & 0.00 & 0.00 \\\\ \nOther digestive conditions & -0.13 & 0.02 & -0.01 & -0.05 & -0.03 & 0.00 & 0.00 & 0.00 & 0.03 & 0.00 \\\\ \nOther diseases of the nervous system and sensory organs & -0.08 & 0.12 & -0.10 & -0.04 & -0.04 & 0.01 & 0.01 & 0.01 & 0.02 & 0.00 \\\\ \nOther diseases of the osteo-articular system + muscles and connecting tissue & -0.03 & 0.00 & -0.06 & 0.00 & 0.01 & 0.02 & -0.01 & 0.00 & 0.00 & 0.00 \\\\ \nOther endocrinological, metabolic and nutritional conditions  & -0.27 & 0.23 & 0.12 & 0.03 & -0.02 & 0.01 & -0.01 & 0.00 & 0.01 & 0.00 \\\\ \nOther external injury and poisoning  & 0.23 & -0.10 & -0.03 & -0.06 & 0.04 & 0.05 & -0.04 & -0.03 & 0.00 & 0.00 \\\\ \nOther genito-urinary diseases  & -0.37 & 0.26 & -0.07 & -0.06 & -0.07 & 0.00 & 0.02 & 0.02 & 0.00 & 0.00 \\\\ \nOther heart disease & -0.36 & 0.28 & 0.07 & 0.01 & -0.02 & -0.01 & -0.01 & 0.00 & 0.10 & 0.02 \\\\ \nOther ill-defined symptoms and conditions & -0.49 & 0.59 & 0.47 & 0.18 & 0.16 & 0.05 & 0.03 & 0.01 & 0.03 & 0.03 \\\\ \nOther illnesses relating to circulation  & -0.23 & 0.07 & -0.06 & -0.02 & -0.01 & 0.00 & -0.01 & 0.00 & 0.06 & 0.00 \\\\ \nOther infectious diseases and parasites & -0.05 & 0.01 & -0.07 & -0.04 & 0.01 & 0.00 & 0.01 & 0.01 & 0.01 & 0.00 \\\\ \nOther malignent tumours & 0.09 & -0.29 & -0.04 & 0.02 & 0.04 & -0.02 & -0.02 & 0.00 & 0.04 & 0.00 \\\\ \nOther psychological and behavioural disorders  & -0.40 & 0.36 & -0.03 & -0.07 & -0.11 & -0.02 & 0.01 & -0.01 & 0.01 & 0.00 \\\\ \nOther respiratory ailments & -0.26 & 0.17 & 0.04 & 0.02 & 0.02 & -0.01 & 0.00 & -0.01 & 0.03 & 0.00 \\\\ \nOther tumours & 0.19 & -0.25 & 0.01 & -0.01 & 0.03 & 0.00 & -0.03 & 0.02 & 0.01 & 0.00 \\\\ \nPneumonia & -0.38 & 0.38 & 0.17 & 0.04 & -0.03 & 0.00 & -0.01 & 0.00 & 0.01 & 0.00 \\\\ \nRhumatoid arthritis and osteoarthritis & -0.23 & 0.02 & -0.22 & -0.08 & 0.00 & 0.00 & 0.00 & -0.05 & 0.00 & 0.00 \\\\ \nRoad accidents & 2.47 & 1.05 & -0.33 & 0.36 & -0.03 & 0.01 & 0.00 & 0.00 & 0.02 & 0.15 \\\\ \nSuicides & 1.39 & 0.04 & 0.31 & -0.48 & 0.06 & -0.02 & 0.01 & 0.00 & 0.02 & 0.04 \\\\ \nTuberculosis & 0.13 & -0.34 & 0.01 & -0.04 & 0.01 & 0.02 & -0.01 & -0.02 & 0.00 & 0.00 \\\\ \nUnknown or unspecified causes & 0.43 & 0.05 & 0.13 & -0.08 & 0.01 & 0.01 & 0.01 & 0.00 & 0.03 & 0.01 \\\\ \nViral hepatitis & 0.49 & -0.10 & -0.09 & 0.04 & -0.02 & -0.02 & 0.00 & 0.00 & 0.00 & 0.00 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n\n\n:::\n\n\n::: {.callout-tip title='Solution'} \n\n\n`inertia`\n: a numerical vector with length matching the number of rows of `coord`, `contrib` and `cos2`. \n\n> Inertia is the way CA measures variation between row profiles. Total inertia is the $\\Chi^2$ statistic divided by sample size. \n\n\nRow inertia can be obtained by multiplying the row marginal probability by the squared Euclidean norm of \nthe row in the principal coordinate matrix. \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith (ca_79_row,\n  sum(abs(r* (rowSums(coord^2)) - inertia))\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.877449e-16\n```\n\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n::: {.callout-tip title='Solution'} \n \n`cos2`\n: Coefficients of matrix `cos2` are the share of row inertia from the corresponding cell in `coord`\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith (ca_79_row,\n  norm((diag(r/inertia) %*% coord^2) - cos2, type='F')\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5.432216e-16\n```\n\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n::: {.callout-tip title='Solution'} \n \n`contrib`\n: \n\nNot too surprisingly, `coord`, `contrib`, and `cos2` share the same row names and column names.   \n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(ca_79$call$X)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 529974\n```\n\n\n:::\n\n```{.r .cell-code}\nsum((rowSums(ca_79$call$X)/sum(ca_79$call$X) - r)^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6.311339e-35\n```\n\n\n:::\n:::\n\n\n\n\n\n\nThe Row Profiles are the rows of matrix `R` below\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nP <- as.matrix(with(ca_79$call, Xtot/N))\ncoord <- ca_79_row$coord\ninertia <- ca_79_row$inertia\n\nr <- ca_79$call$marge.row\nc <- colSums(P)\n\nn <- nrow(P)\np <- ncol(P)\n\nR <- diag(r^(-1)) %*% P \n\nQ <- R - matrix(1, nrow = n, ncol = n) %*% P\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nM <- diag(r^(-1)) %*% P %*% diag(c^(-1)) - matrix(1, nrow=n, ncol=p)\n\nn * norm(diag(r^(1/2)) %*% M %*% diag(c^(1/2)), type = \"F\")^2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 29.39279\n```\n\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n\n::: {.callout-tip title='Solution'} \n \nWe can now display a scatterplot from component `coord`. This is called a *Row Plot*. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_scat <-  ( \n  prep_rows |> \n    ggplot() +\n    aes(x=`Dim 1`, y=`Dim 2`, label=name) +\n    geom_point() +\n    coord_fixed() \n  ) \n\np_scat |> plotly::ggplotly()\n```\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-26-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n \n:::\n\n\n::: {.callout-tip title='Solution'} \n \nWith little effort, it is possible to scale the points so as to tell  the reader the relative numerical importance of each cause of death. Coloring/filling the points using *inertia* also helps: high inertia rows match light-colored points.  \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nppp <- prep_rows |> \n    ggplot() +\n    aes(x=`Dim 1`, \n        y=`Dim 2`, \n        label=name, \n        size=prop, \n        fill=log10(inertia),\n        color=log10(inertia)) +\n    geom_point(alpha=0.75) +\n    scale_size_area() +\n    coord_fixed() +\n    scale_fill_viridis_c(aesthetics=c(\"fill\", \"color\"), \n                         guide=\"colorbar\", \n                         direction = 1) +\n    ggtitle(\n      \"Mortality France 1979: Row plot\"\n    )\n  \nppp |> plotly::ggplotly()\n```\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-27-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\n# (ca_79$row)$contrib\n```\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n::: {.callout-note title='Question'} \n \nPlot the result of row profile analysis using `plot.CA` from `FactoMineR`.\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n:::::   \n\n\n\n::: {.callout-note title='Question'} \n \nPerform  column profiles analysis\n\n:::\n\n::::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(ca_79_row)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"coord\"   \"contrib\" \"cos2\"    \"inertia\"\n```\n\n\n:::\n:::\n\n\n\n\n\n\n:::::\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nage_group_names <-  str_match(rownames(ca_79$col$coord), '([\\\\w \\\\-]*) \\\\(79\\\\)')[,2]\n\nprep_cols <- ca_79$col$coord |> \n  as_tibble() |> \n  mutate(name= age_group_names) |> \n  relocate(name) |> \n  mutate(prop=c, inertia=ca_79$col$inertia)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  prep_cols |> \n    ggplot() +\n    aes(x=`Dim 1`, \n        y=`Dim 2`, \n        label=name, \n        size=prop, \n        fill=log10(inertia),\n        color=log10(inertia)) +\n    geom_point(alpha=0.75) +\n    scale_size_area() +\n    coord_fixed() +\n    scale_fill_viridis_c(aesthetics=c(\"fill\", \"color\"),direction = 1) +\n    ggtitle(\n      \"Mortality France 1979: Col plot\"\n    )) |> plotly::ggplotly()\n```\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-31-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n \n:::\n\n\n\n:::::\n\n\n## Symmetric plots \n\n::: {.callout-note title=\"Question\"}\n\nBuild the symmetric plots (biplots)  for correspondence analysis of Mortalitity data\n\n:::\n\n\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.content-visible when-profile='solution'} \n \n### From the shelf \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot.CA(ca_79)\n```\n:::\n\n\n\n\n\n\n:::\n\n\n::: {.callout-tip title='Solution'} \n\n### {{< fa jedi >}}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\nprep_rows |> \n    ggplot() +\n    aes(x=`Dim 1`, \n        y=`Dim 2`, \n        label=name, \n        size=prop, \n        fill=log10(inertia),\n        color=log10(inertia)) +\n    geom_point(alpha=0.75) +\n    scale_size_area() +\n    coord_fixed() +\n    scale_fill_viridis_c(aesthetics=c(\"fill\", \"color\"),direction = 1) +\n    geom_point(data = prep_cols,\n      aes(x=`Dim 1`, \n        y=`Dim 2`, \n        label=name, \n        size=prop, \n        fill=log10(inertia),\n        color=log10(inertia)\n      ),\n      shape=\"square\",\n      alpha=.5,      \n    )\n) |> plotly::ggplotly()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in geom_point(data = prep_cols, aes(x = `Dim 1`, y = `Dim 2`, label =\nname, : Ignoring unknown aesthetics: label\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-33-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n::: {.content-visible when-profile='solution'} \n\n::: {.callout-tip title='Solution'} \n \nIt is convenient to use distinct color scales for  rows and columns. \n\n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\nprep_rows |> \n    ggplot() +\n    scale_size_area() +\n    coord_fixed() +\n    aes(x=`Dim 1`, \n        y=`Dim 2`, \n        text=name, \n        size=prop, \n        fill=log10(inertia)) +\n    geom_point(alpha=0.75) +\n    scale_fill_viridis_c(option=\"D\") +\n    geom_point(data = prep_cols,\n      aes(x=`Dim 1`, \n        y=`Dim 2`, \n        text=name, \n        size=prop, \n        color=log10(inertia)\n      ),\n      shape=\"square\",\n      alpha=.5,      \n    ) +\n    scale_color_viridis_c(option=\"F\") +\n    theme_minimal(\n    )  \n)  |> plotly::ggplotly()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in geom_point(data = prep_cols, aes(x = `Dim 1`, y = `Dim 2`, text =\nname, : Ignoring unknown aesthetics: text\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-34-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::\n\n## Mosaicplots\n\n::: {.callout-note title=\"Question\"}\n\nMosaic plots provide an alternative way of exploring contingency tables. They are particularly handy when handling 2-way contingency tables.\n\nDraw mosaic plots for the two contingency tables living inside `mortality` datasets.\n\n\n:::\n\n\n\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title='Solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality |> \n  select(ends_with('(06)')) |> \n  chisq.test() |> \n  broom::glance()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in chisq.test(select(mortality, ends_with(\"(06)\"))): Chi-squared\napproximation may be incorrect\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 4\n  statistic p.value parameter method                    \n      <dbl>   <dbl>     <int> <chr>                     \n1   229784.       0       488 Pearson's Chi-squared test\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmortality |> \n  select(ends_with('(06)')) |> \n  as.matrix() |> \n  as.table() |> \n  mosaicplot(color = T)\n```\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-36-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n::: {.callout-note title=\"Question\"}\n\nAre you able to deliver an interpretation of this Correspondence Analysis?\n\n:::\n \n\nHierarchical clusetring of row profiles \n----------------------------------------\n\n::: {.callout-note}\n\n### Question\n\nBuild the standardized matrix for row profiles analysis. Compute the pairwise distance matrix using the $\\chi^2$ distances. Should you work centered row profiles?\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\nWe use the weighted $\\ell_2$ distances defined by the product of the two marginal distributions. The squared distance between the conditional probabilities defined by rows $a$ and $a'$ is \n$$\\sum_{b}  \\frac{\\left( N_{a,b}/N_{a,.} - N_{a',b}/N_{a',.}\\right)^2}{N_{.,b}/N}$$\n\nThe $\\ell_2$ distance between the rows of the principal coordinates matrix `row$coord` coincides since they are all centered and normalized with respect to $(N_{.,b}/N)$. \n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndist_causes_79 <- ca_79$row$coord[,1:8] |> \n  dist()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhc_79 <- hclust(dist_causes_79, method = \"single\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nstopifnot(\n  require(ggdendro),\n  require(dendextend),\n  require(sloop)\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: ggdendro\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: dendextend\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n---------------------\nWelcome to dendextend version 1.17.1\nType citation('dendextend') for how to cite the package.\n\nType browseVignettes(package = 'dendextend') for the package vignette.\nThe github page is: https://github.com/talgalili/dendextend/\n\nSuggestions and bug-reports can be submitted at: https://github.com/talgalili/dendextend/issues\nYou may ask questions at stackoverflow, use the r and dendextend tags: \n\t https://stackoverflow.com/questions/tagged/dendextend\n\n\tTo suppress this message use:  suppressPackageStartupMessages(library(dendextend))\n---------------------\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dendextend'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:ggdendro':\n\n    theme_dendro\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:stats':\n\n    cutree\n```\n\n\n:::\n:::\n\n\n\n\n\n\nThe instance of `hclust` is transformed into a an object of class `dendro`.\nClass `dendro` is equipped with a variety of functions/methods for analyzing, visualizing, and exploiting the result of `hclust()`. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndendro_79 <- dendro_data(hc_79)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(dendro_79)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"dendro\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n(\ndendro_79 |> \n  ggdendrogram(\n    leaf_labels = T, \n    rotate = T) + \n  ggdendro::theme_dendro() +\n  scale_y_reverse()\n  ) |> plotly::ggplotly()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for y is already present.\nAdding another scale for y, which will replace the existing scale.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-ca-mortality_files/figure-pdf/unnamed-chunk-42-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\n:::::\n\n::: {.callout-note}\n\n\n\n:::\n\n\n\n::: {.callout-note}\n\n### Question\n\nPerform hierarchical clustering of row profiles with method/linkage `\"single\"`. Check the definition of the method. Did you know the underlying algorithm? If yes, in which context did you get acquainted with this algorithm?\n\n\n:::\n\n::: {.callout-note}\n\n### Question\n\nChoose the number of classes (provide justification).\n\n\n:::\n\n::: {.callout-note}\n\n### Question\n\nCan you explain the size of the different classes in the partition?\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n:::::\n\nAtypical row profiles\n---------------------\n\n::: {.callout-note}\n\n### Question\n\nRow profiles that do  not belong to the majority class are called *atypical*. \n\n1. Compute the share of inertia of atypical row profiles. \n\n1. Draw a symmetric plot (biplot) outlining the atypical row profiles. \n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n:::::\n\n\nInvestigating independence/association\n----------------------\n\n::: {.callout-note}\n\n### Question \n\n1.  Calculate the theoretical population table for `deces`. Do you    possible to carry out a chi-squared test?\n\n1.  Perform a hierarchical classification of the line profiles into two\n    classes.\n\n3.  Merge the rows of `deces` corresponding to the same class (you can use the\n    the `tapply` function), and perform a chi-square test.\n    chi-square test. What's the conclusion?\n\n4.  Why is it more advantageous to carry out this grouping into two\n    classes compared to arbitrarily grouping two classes,\n    in order to prove the dependence between these two variables?\n\n:::\n\n\nAbout the \"average profile\"\n---------------------------------\n\n::: {.callout-note}\n\n### Question\n\n1.  Represent  individuals from the  majority class. Do they all seem to you to correspond to an average profile?\n\n1.  Try to explain this phenomenon considering the way in which    hierarchical classification uses the Single Linkage method.\n\n:::\n\n\n\n\n::: {.callout-caution}\n\n### Caveat\n\nThe `mortality` dataset should be taken with  grain of salt. Assigning a single *cause* to every death is not a trivial task. It is even questionable: if somebody dies from some infection because she could not be cured using an available drug due to another preexisting pathology, who is the culprit? \n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{booktabs}\n\\usepackage{caption}\n\\usepackage{longtable}\n\\usepackage{colortbl}\n\\usepackage{array}\n\\usepackage{anyfontsize}\n\\usepackage{multirow}\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}