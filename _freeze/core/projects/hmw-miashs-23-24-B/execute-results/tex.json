{
  "hash": "54991021f5f62ad8d77ab2183a64f121",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Life Tables\"\ndate: \"2025-01-29 06:21:06.826189\"\n\nexecute:\n  echo: true\n  eval: true\n  collapse: true\n\nformat:\n  html:\n    output-file: hmw-miashs-23-24-b.html\n  pdf:\n    output-file: hmw-miashs-23-24-b.pdf\n\n\n\ndraft: true\nengine: knitr\n---\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Devoir II : Etude de tables de mortalite\n\n\n::: {.callout-important}\n\n### Attendu\n\nUn fichier `nom1_nom2.Rmd` ou `nom1_nom2.qmd` au format `Rmarkdown` (`.Rmd`) ou `Quarto` (`.qmd`), compilable (mais pas compilé) en format `html`, à charger sur [Moodle](https://moodle.u-paris.fr/course/view.php?id=13227).\n\nDans ce fichier `nom1_nom2.xxx`, on trouvera le code nécessaire à la génération des graphiques et des tables correspondants aux questions ci-dessous. \n\nDate de rendu : 29 mai 2024 à 23h59\n\nÀ réaliser en binôme. \n\n:::\n\n## Tables de mortalité  (1900-1925)\n\n\nCe devoir porte sur les tables de mortalité (*life tables*) américaines et européennes entre 1900 et 1925.\n\nLes tables ont été obtenues de [https://www.mortality.org](https://www.mortality.org). \n\nNous étudions les  tables de mortalité de quelques pays d'Europe occidentale  (France, Grande-Bretagne --en fait, Angleterre et Pays de Galles--, Italie, Pays-Bas, Espagne, et  Suède) et des États-Unis d'Amérique. \n\n\nLes tables peuvent être téléchargées à l'aide des instructions suivantes :\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatafile <- 'full_life_table.Rds'\nfpath <- stringr::str_c(\"./DATA/\", datafile) \n\n# here::here('DATA', datafile)   \n# check getwd() if problem \n\nif (! file.exists(fpath)) {\n  download.file(\"https://stephane-v-boucheron.fr/data/full_life_table.Rds\", \n                fpath,\n                mode=\"wb\")\n}\n\nlife_table <- readr::read_rds(fpath)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlife_table <- life_table %>%\n  mutate(Country = as_factor(Country)) %>%\n  mutate(Country = fct_relevel(Country, \"Spain\", \"Italy\", \"France\", \n  \"England & Wales\", \"Netherlands\", \"Sweden\", \"USA\")) %>%\n  mutate(Gender = as_factor(Gender)) \n\nlife_table <- life_table %>%\n  mutate(Area = fct_collapse(Country, \n                        SE = c(\"Spain\", \"Italy\", \"France\"), \n                        NE = c(\"England & Wales\", \"Netherlands\", \"Sweden\"), \n                        USA=\"USA\")) \n```\n:::\n\n\n\n\n\n\nSur les données françaises, le document [Tables de mortalité françaises pour les XIXe et XXe siècles et projections pour le XXIe siècle](https://www.lifetable.de/data/FRA/FRA000018061997CY1.pdf) contient des informations utiles sur la  construction des tables de mortalité.\n\n\n\n### Notation (Rappel)\n\nDans la suite $F$ désigne une fonction de répartition sur $\\mathbb{N} = \\mathbb{Z}_+$, et $\\overline{F}=1 - F$ la fonction de survie associée. Cette fonction $F$ est définie à partir des quotients de mortalité (voir plus bas). Elle ne décrit pas la pyramide des âges. On définit une fonction pour chaque année $t$. Pour chaque année, pays, sexe, $F_t(x)$ est la proportion des membres d'une cohorte (fictive) qui vivent au moins jusqu'à l'âge $x$ dans l'année $t$. \n\n`qx`\n: (age-specific) risque de décès à l'age (révolu) $x$, ou encore  *quotient de mortalité* à l'age  $x$ pour l'année $t$:\n$q_{t,x} = \\frac{\\overline{F}_t(x) - \\overline{F}_t(x+1)}{\\overline{F}_t(x)}$.  \nPour chaque année, chaque âge, $q_{t,x}$ est  déterminé par les données de l'année.\n\nNous avons aussi  $$\\overline{F}_{t}(x+1) = \\overline{F}_{t}(x) \\times (1-q_{t,x+1})\\, .$$\n\n`mx`\n: *taux  central de  décès* à l'âge (révolu)  $x$  durant l'année $t$. C'est relié à  $q_{t,x}$ par \n$$m_{t,x} = -\\log(1- q_{t,x}) \\,,$$ \nou  de manière équivalente $q_{t,x} = 1 - \\exp(-m_{t,x})$. \n\n\n`lx`\n: la *fonction de survie*: un multiple de  proportion  de  personnes encore vivantes à l'âge $x$. Ces valeurs sont calculées à  partir de $q_{t,x}$  via la formule \n$$l_t(x+1) = l_t(x) \\times (1-q_{t,x}) \\, ,$$\navec  $l_{t,0}$, la racine (*radix*) de la  table, en fait, choisi égal à $100000$.\nLes fonctions  $l_{t,\\cdot}$ et $\\overline{F}_t$ sont liées par \n$$l_{t,x + 1} = l_{t,0} \\times \\overline{F}_t(x)\\,.$$\n\n\n\n`dx`\n: $d_{t,x} = q_{t,x} \\times l_{t,x}$\n\n`Tx`\n: Nombre total de  personnes-années  vécues  par la cohorte des gens d'âge compris entre $x$ et $x+1$ (pour une année donnée dans une société donnée). C'est nombre d'années vécues par les  $l_{t, x+1}$ personnes qui  survivent à l'intervalle de temps, et les  $d_{t,x}$ personnes qui décèdent durant cette intervalle (ici l'intervalle est une année). Les premiers contribuent chacun exactement  $1$ année, alors que ces derniers  contribuent, en moyenne, approximativement pour une demi-année. Ainsi  $L_{t,x} = l_{t,x+1} + 0.5 \\times d_{t,x}$. Cette approximation équivaut à supposer qu'un  décès à l'âge révolu $x$,  intervient en moyenne au milieu de l'année. C'est acceptable excepté durant la première année  (âge 0) et aux grands âges. Nous en restons à l'approximation simpliste $L_{t,x}= l_{t,x+1}$.\n\n`ex`:\n: Espérance de vie *résiduelle* à l'âge $x$ pour l'année $t$. C'est (presque) l'espérance de la loi sur $[0, \\infty)$ définie par $F_t$ (et donc par les `qx`), de la façon suivante: si $X \\sim F$, c'est \n\n$$\\mathbb{E}_{\\{X \\geq x\\}}\\left[X -x \\right]= \\frac{\\mathbb{E}\\left[(X-x) \\mathbb{I}_{X\\geq x}\\right]}{\\mathbb{E}\\left[\\mathbb{I}_{X\\geq x}\\right]}$$ \n\n\n\n::: {.callout-tip}\n\nLe package `R` nommé `demography` met à disposition un certain nombre d'outils et de concepts élaborés par les démographes.\n\n:::\n\n\nSources: *Demography: measuring and modeling population processes*. Preston, Heuveline et Guillot.  Blackwell Publishing. 2001.\n\n\n\n::: {.callout-note}\n\n### Question\n\nPour chaque pays et chaque sexe, illustrer et commenter (brièvement) l'évolution des quotients de mortalité entre 1900 et 1913. \n\nRemarquer qu'on peut étudier `qx` comme une fonction de l'année $t$,\nmais aussi pour une année donnée, étudier `qx` comme  une fonction de l'âge `x`.   \n\n:::\n\n\n::: {.content-visible when-profile='solution'} \n\nSouligner la singularité de l'année 1911\n\nNoter dans les données espagnoles par année, les maxima locaux des quotients de mortalité aux âges 50, 60, 70.\n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparams = list(\n  truc= \"Science des Données\",\n  year= 2023 ,\n  curriculum= \"L3 MIASHS\",\n  university= \"Université Paris Cité\",\n  homepage= \"https://stephane-v-boucheron.fr/courses/scidon\",\n  moodle= \"https://moodle.u-paris.fr/course/view.php?id=13227\",\n  country_code= 'fr_t',\n  country= 'France',\n  datafile= 'full_life_table.Rds',\n  year_p= 1900,\n  year_e= 1925\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndummy_data <- dplyr::filter(life_table, FALSE)\n\nproto_plot <- ggplot(dummy_data,\n                     aes(x=Age,\n                         y=qx,\n                         col=Area,\n                         linetype=Country,\n                         shape=Country)) +\n              scale_y_log10() +\n              scale_x_continuous(breaks = c(seq(0, 100, 10), 109)) +\n              ylab(\"Mortality quotients\") +\n              labs(linetype=\"Country\") +\n              theme_bw()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nproto_plt2 <-\n  ggplot() +\n  aes(x=Age, y=qx, colour=Area, frame=Year, linetype=Country) +\n  geom_point(size=.1) +\n  geom_line(linewidth=.1) +\n  scale_y_log10() +\n  labs(linetype=c(\"Country\")) +\n  scale_x_continuous(breaks = c(seq(0, 100, 10), 109)) +\n  xlab(\"Age\") +\n  ylab(\"Central death rates\") +\n  facet_grid(cols=vars(Gender))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwith(params,\n(proto_plt2 %+%\n  (life_table %>% filter(between(Year, year_p, year_e), Gender != 'Both', Age < 90))  +\n  ggtitle(\"Central death rates 1900-1925\"))) %>%\n  plotly::ggplotly()\n```\n:::\n\n\n\n\n\n\n\n:::\n\n::: {.callout-note}\n\n### Question\n\nPour chaque pays, chaque sexe, chaque année entre 1900 et 1913, puis entre 1921 et 1925, effectuer une *régression linéaire* du logarithme du quotient de mortalité en fonction de l'âge,  pour les âges compris entre 30 et 70 ans. \n\n\nIllustrer et commenter.\n\n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_regs <- life_table |> \n  filter(between(Year, 1900L, 1925L), Gender!='Both') |>  \n  filter(between(Age, 40, 70)) |>\n  nest(.by=c(Country, Gender, Year))  |>\n  mutate(models = lapply(data, function(df) lm(log(qx) ~ Age, data = df))) |>  \n  select(Country, Gender, Year, models) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_regs$models[[1]] |> \n  broom::augment() |>\n  ggplot() +\n    aes(x=Age, y=`log(qx)`) +\n    geom_point() +\n    geom_smooth(method=\"lm\", formula=y~x, se=FALSE) +\n    labs(\n      title=df_regs$Country[1],\n      subtitle=str_c(df_regs$Year[1], ', ', df_regs$Gender[1])\n    )\n```\n:::\n\n\n\n\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nslope_intercep <- df_regs |>\n  mutate(coeffs = lapply(models, \\(x) coefficients(x))) |>\n  mutate(interc = lapply(coeffs, \\(x) x[1]), \n         slope = lapply(coeffs, \\(x) x[2])) |>\n  select(-models, -coeffs) |>\n  unnest(c(interc, slope))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  slope_intercep |> \n  ggplot() +\n  aes(x=interc, y=slope, color=Year) +\n  geom_point() +\n  facet_grid(col=vars(Gender), row=vars(Country))) |>\n  plotly::ggplotly()\n```\n:::\n\n\n\n\n\n:::\n\n::: {.callout-note}\n\n### Question\n\nPour chaque pays et chaque sexe, considérer la *cohorte* des individus nés en 1890. Déterminer   les quotients de mortalité effectivement subis par cette cohorte entre 1890 et 1980. Illustrer la différence entre les quotients de mortalité tirés des *tables du moment* de l'année 1890 et les quotients de mortalités effectivement subis.  \n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlife_table_1890 <- life_table |>\n  filter(Year == 1890) |>\n  select(Country, Gender, Age, Area, qx) \n\ncross_life_table <- (life_table |>\n  filter(Year >= 1890, Gender != 'Both') |>\n  select(Country, Gender, Year, Age, Area, qx) |>\n  filter(1890 + Age == Year) |> \n  inner_join(life_table_1890,\n    by=c('Country', 'Gender', 'Age', 'Area')\n    ) \n) \ncross_life_table\n```\n:::\n\n\n\n\n\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  cross_life_table |>\n  filter(Country=='France') |>\n  ggplot() +\n  aes(x=Age) +\n  geom_point(aes(y=qx.x), shape='triangle') +\n  geom_line(aes(y=qx.y), linewidth=.5) +\n  scale_y_log10() +\n  facet_grid(col=vars(Gender)) +\n  labs(\n    title = \"France\"\n  )\n  ) |> plotly::ggplotly()\n```\n:::\n\n\n\n\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  cross_life_table |>\n  ggplot() +\n  aes(x=Age) +\n  geom_point(aes(y=qx.x), \n             shape='triangle',\n             size=.5,\n             alpha=.5) +\n  geom_line(aes(y=qx.y), linewidth=.5) +\n  scale_y_log10() +\n  facet_grid(row=vars(Country),\n             col=vars(Gender)) +\n  labs(\n    title = \"\"\n  )\n  ) |> plotly::ggplotly()\n```\n:::\n\n\n\n\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  cross_life_table |>\n  ggplot() +\n  aes(x=Age) +\n  geom_point(aes(y=qx.x/qx.y), \n             shape='triangle',\n             size=.5,\n             alpha=.5) +\n#  geom_line(aes(y=qx.y), linewidth=.5) +\n  scale_y_log10() +\n  facet_grid(row=vars(Country),\n             col=vars(Gender)) +\n  ylab(\"Ratio between experienced Qx and Qx at birth\") +\n  labs(\n    title = \"\"\n  )\n  ) |> plotly::ggplotly()\n```\n:::\n\n\n\n\n\n:::\n\n\n::: {.content-visible when-profile=\"solution\"}\n\nVoir Chapitre 2 Section 2.4 *The lexis diagram*, à propos de la notion de taux par âge pour une cohorte (*age specific rate for cohorts*).\n\nSouligner que les personnes âgées de 35 ans résidants en France en 1925 ne sont pas toutes issues de la cohorte  des personnes nées en France en 1890: il faudrait faire la part de l'immigration et des modifications de frontière (Alsace-Moselle).    \n\n:::\n\n::: {.content-visible when-profile='solution'} \n \nDonnées françaises.\n\n- évolution des quotients de mortalité des hommes aux âges 20-30 ans (1914-1918). Le rapport entre quotient de mortalité subit et le quotient de mortalité de l'année de naissance pas à 10 en 1914, décroit jusqu'à 4.8 en 1917, grimpe à 7 en 1918, puis redescend vers une valeur inférieure à 1 en 1921.  \n- variation brutale des quotients de mortalité chez les femmes en 1918, 1919, 1920.\n- le rapport augmente à nouveau en 1940, et surtout en 1944\n  \nDonnées anglaises et galloises.\n\n- évolution des quotients de mortalité des hommes aux âges 26-28 ans (1916-1918). Le scenario differe de celui de la France.\n- variation brutale des quotients de mortalité chez les femmes et les hommes en 1918, 1919, 1920.\n- variation des ratios en 1940\n- les ratios postérieurs à 1950 sont meilleurs pour les femmes\n\nDonnées italiennes \n\n- Le rapport entre quotient de mortalité subit et le quotient de mortalité de l'année de naissance passe à 4 en 1915, et croît jusq'en  1918, puis redescend vers une valeur inférieure à 1 en 1921.\n- variation des ratios entre 1940 et 1945, surtout durant les dernières anneés.\n- les ratios postérieurs à 1950 sont meilleurs pour les femmes.\n  \n  \nDonnées suédoises, néerlandaises.\n\n- Variation brutale des quotients de mortalité chez les femmes et les hommes en 1918, 1919, 1920.\n- Au Pays-Bas, augmentation importantes des rapports entre quotients de mortalité subis et quotients de mortalité à la naissance en 1945.\n  \n:::\n\n\n## Barème\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n| Critère | Points  | Détails |\n|:----------|:-------:|:--------|\n|Orthographe et grammaire | 20% | English/Français {{<  fa pen-fancy >}}|\n|Graphiques  | 25% | Choix des  `aesthetics`, `geom`, `scale` ... {{<  fa chart-area >}}|\n|Style des Graphiques  | 15% | Titres, légendes, étiquettes ... {{<  fa chart-area >}} |\n|Manipulations de tables | 25% | {{<  fa database >}} |\n|Respect DRY  | 15% | Principe DRY  {{<  fab wikipedia-w  >}} [ Wikipedia ](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself)|\n\n\n\n::: {.callout-caution}\n\nCeci n'est pas un devoir d'Histoire. Ne cherchez pas à montrer votre culture. Demandez-vous  ce qu'il y a de remarquable dans les données, et énoncez les questions que ces données peuvent poser aux historiens.\n\n\n:::\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlife_table |> \n  filter(Country=='France', between(Year,1895,1905), Gender=='Female', Age %in% c(0,1)) |> \n  select(Year, Age, ex)\n```\n:::\n\n\n\n\n\n\n\n:::::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}