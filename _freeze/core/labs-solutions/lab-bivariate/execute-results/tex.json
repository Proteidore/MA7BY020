{
  "hash": "ef8068045bd0810d15d3a8a9b92c304a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Bivariate analysis'\ncategories: [Bivariate analysis, Boxplots, Pairplots]\ndate: \"2025-02-04 22:44:22.769295\"\n\n\nexecute:\n  echo: true\n  eval: true\n  collapse: true\n\n\nformat:\n  html:\n    output-file: lab-bivariate.html\n  pdf:\n    output-file: lab-bivariate.pdf\n\n# params:\n#   truc: html\n#   year: 2024 \n#   curriculum: \"M1 MIDS & MFA\"\n#   university: \"Université Paris Cité\"\n#   homepage: \"https://s-v-b.github.io/MA7BY020\"\n#   moodle: \"https://moodle.u-paris.fr/course/view.php?id=6143\"\n---\n\n\n\n\n\n\n::: {layout=\"[80,20]\"}\n\n::: {#first-column}\n\n|                            |\n|:---------------------------|\n| {{< var curriculum >}}     |\n| {{< var university >}}     |\n| Année {{< var year >}}     |\n| {{< var homepage >}}       |\n| {{< var moodle >}}         |\n\n\n::: \n\n::: {#second-column}\n![](/images/UniversiteParis_monogramme_couleur_RVB.png){align=\"right\" style=\"size:50px;\" width=75}\n:::\n\n:::\n\n\n\n\n::: {.callout-important}\n\n### Objectives\n\nIn Exploratory analysis of tabular data, bivariate analysis is the second step. It consists in exploring, summarizing, visualizing pairs of columns of a dataset.\n\n:::\n\n\n## Setup\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstopifnot(\n  require(glue),\n  require(magrittr),\n  require(lobstr),\n  require(arrow),\n  require(ggforce),\n  require(vcd),\n  require(ggmosaic),\n  require(httr),\n  require(patchwork),\n  require(corrr),\n  require(gapminder),\n  require(slider),\n  require(tidyverse) \n) \n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\nBivariate techniques depend on the types of columns we are facing.\n\nFor *numerical/numerical* samples \n\n- Scatter plots\n- Smoothed lineplots (for example linear regression)\n- 2-dimensional density plots\n\nFor *categorical/categorical* samples : mosaicplots and variants\n\nFor *numerical/categorical* samples\n\n- Boxplots per group\n- Histograms per group\n- Density plots per group\n\n\n\n# Dataset\n\n\n\nOnce again we rely on the `Recensement` dataset.\n\n> Since 1948, the US Census Bureau  carries out a monthly Current Population Survey,  collecting data concerning residents aged above 15  from $150 000$ households.  This survey is one of the most important sources of information concerning the american workforce. Data reported in file `Recensement.txt`  originate from the 2012 census. \n\nLoad the data into the session environment and call it `df`. Take advantage \nof the fact that we saved the result of our data wrangling job in a self-documented file format. Download a `parquet` file from the following URL: \n\n`https://stephane-v-boucheron.fr/data/Recensement.parquet`\n\n\n\n::: {.callout-note title=\"Question\"}\n\nDownload a `parquet` file from the following URL: \n\n`https://stephane-v-boucheron.fr/data/Recensement.parquet`\n\n:::\n\n::: {.callout-tip}\n\n- Use `httr::GET()` and `WriteBin()`\n- Use `download.file()`\n- Use `fs` to handle files and directories\n\n:::\n\n::: {.content-visible when-profile=\"solution\"}\n\n::::: {.callout-tip title=\"Solution\" collapse=\"true\"}\n\n#### Manage the `DATA` sub-directory\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (fs::dir_exists('DATA')){\n  datapath <- \"DATA\"\n} else {\n  datapath <- \"../DATA\"\n}\n```\n:::\n\n\n\n\n\n#### Using `httr::get` and `writeBin`\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfname <- \"Recensement.parquet\"\n\nfpath <- paste(datapath, fname, sep=\"/\")\n\nurl <- 'https://stephane-v-boucheron.fr/data/Recensement.parquet'\n\nif (!file.exists(fpath)) {\n  tryCatch(\n    expr = { \n    \n      rep <- httr::GET(url)\n      stopifnot(rep$status_code==200)\n    \n      con <- file(fpath, open=\"wb\")\n      writeBin(rep$content, con)\n      close(con)\n    }, \n    warning = function(w) {\n      glue(\"Successful download but {w}\")\n    }, \n    error = function(e) {\n      stop(\"Houston, we have a problem!\")    # error-handler-code\n    }, \n    finally = {\n      if (exists(\"con\") && isOpen(con)){\n        close(con)\n      }\n    } \n  )\n} \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!file.exists(fpath)) {\n  tryCatch(\n    expr = {\n      download.file(url, fpath, mode=\"wb\", quiet=T)\n      print(glue::glue('>>> file downloaded at {fpath}\\n'))\n    }, \n    warning = function(w) {\n      glue::glue(\"Successful download but {w}\")\n    }, \n    error = function(e) {\n      stop(\"Houston, we have a problem!\")    # error-handler-code\n    } \n  )\n}\n```\n:::\n\n\n\n\n\n:::::\n\n:::\n\n::: {.callout-note title=\"Question\"}\n\nLoad the data contained in the downloaded file into the session environment and call it `df`\n\n:::\n\n::: {.content-visible when-profile='solution'} \n\n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- arrow::read_parquet(fpath)\n```\n:::\n\n\n\n\n\n::: \n \n:::\n\n\n\n\n\n\n::: {.cell mesage='false'}\n\n```{.r .cell-code}\ndf |>\n  glimpse()\n## Rows: 599\n## Columns: 11\n## $ AGE        <dbl> 58, 40, 29, 59, 51, 19, 64, 23, 47, 66, 26, 23, 54, 44, 56,~\n## $ SEXE       <fct> F, M, M, M, M, M, F, F, M, F, M, F, F, F, F, F, F, M, M, F,~\n## $ REGION     <fct> NE, W, S, NE, W, NW, S, NE, NW, S, NE, NE, W, NW, S, S, NW,~\n## $ STAT_MARI  <fct> C, M, C, D, M, C, M, C, M, D, M, C, M, C, M, C, S, M, S, C,~\n## $ SAL_HOR    <dbl> 13.25, 12.50, 14.00, 10.60, 13.00, 7.00, 19.57, 13.00, 20.1~\n## $ SYNDICAT   <fct> non, non, non, oui, non, non, non, non, oui, non, non, non,~\n## $ CATEGORIE  <fct> \"Administration\", \"Building \", \"Administration\", \"Services\"~\n## $ NIV_ETUDES <fct> \"Bachelor\", \"12 years schooling, no diploma\", \"Associate de~\n## $ NB_PERS    <fct> 2, 2, 2, 4, 8, 6, 3, 2, 3, 1, 3, 2, 6, 5, 4, 4, 3, 2, 3, 2,~\n## $ NB_ENF     <fct> 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,~\n## $ REV_FOYER  <fct> [35000-40000), [17500-20000), [75000-1e+05), [17500-20000),~\n\ndf |>\n  head()\n## # A tibble: 6 x 11\n##     AGE SEXE  REGION STAT_MARI SAL_HOR SYNDICAT CATEGORIE     NIV_ETUDES NB_PERS\n##   <dbl> <fct> <fct>  <fct>       <dbl> <fct>    <fct>         <fct>      <fct>  \n## 1    58 F     NE     C            13.2 non      \"Administrat~ Bachelor   2      \n## 2    40 M     W      M            12.5 non      \"Building \"   12 years ~ 2      \n## 3    29 M     S      C            14   non      \"Administrat~ Associate~ 2      \n## 4    59 M     NE     D            10.6 oui      \"Services\"    12 years ~ 4      \n## 5    51 M     W      M            13   non      \"Services\"    9 years s~ 8      \n## 6    19 M     NW     C             7   non      \"Services\"    12 years ~ 6      \n## # i 2 more variables: NB_ENF <fct>, REV_FOYER <fct>\n```\n:::\n\n\n\n\n\n\n\n# Categorical/Categorical pairs\n\n\n::: {.callout-note title=\"Question\"}\n\nProject the dataframe on categorical columns\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  select(where(is.factor)) |>\n  head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 9\n  SEXE  REGION STAT_MARI SYNDICAT CATEGORIE  NIV_ETUDES NB_PERS NB_ENF REV_FOYER\n  <fct> <fct>  <fct>     <fct>    <fct>      <fct>      <fct>   <fct>  <fct>    \n1 F     NE     C         non      \"Administ~ Bachelor   2       0      [35000-4~\n2 M     W      M         non      \"Building~ 12 years ~ 2       0      [17500-2~\n3 M     S      C         non      \"Administ~ Associate~ 2       0      [75000-1~\n4 M     NE     D         oui      \"Services\" 12 years ~ 4       1      [17500-2~\n5 M     W      M         non      \"Services\" 9 years s~ 8       1      [75000-1~\n6 M     NW     C         non      \"Services\" 12 years ~ 6       0      [1e+05-1~\n```\n\n\n:::\n:::\n\n\n\n\n\n\n::: \n \n:::\n\n::: {.callout-note title=\"Question\"}\n\n- Explore the connection between `CATEGORIE` and `SEX`. \n- Compute the 2-ways contingency table using `table()`, and  `count()` from `dplyr`. \n\n:::\n\n::: {.callout-tip}\n\n- Use `tibble::as_tibble()` to transform the output of `table()` into a dataframe/tibble.\n- Use `tidyr::pivot_wider()` so as to obtain a wide (but messy) tibble with the same the same shape as the output of `table()`. \n- Can you spot a difference? \n\n:::\n\n::: {.content-visible when-profile=\"solution\"}  \n\n::::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntb <- df |>\n  dplyr::select(CATEGORIE, SEXE) |>\n  table() \n\n# tb\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntb2 <- df |>\n  count(CATEGORIE, SEXE)\n\ntb2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 18 x 3\n   CATEGORIE                          SEXE      n\n   <fct>                              <fct> <int>\n 1 \"Business, Management and Finance\" F        23\n 2 \"Business, Management and Finance\" M        23\n 3 \"Liberal profession\"               F        82\n 4 \"Liberal profession\"               M        51\n 5 \"Services\"                         F        75\n 6 \"Services\"                         M        50\n 7 \"Selling\"                          F        30\n 8 \"Selling\"                          M        18\n 9 \"Administration\"                   F        72\n10 \"Administration\"                   M        22\n11 \"Agriculture, Fishing, Forestry\"   F         2\n12 \"Agriculture, Fishing, Forestry\"   M         8\n13 \"Building \"                        M        36\n14 \"Repair and maintenance\"           M        32\n15 \"Production\"                       F         9\n16 \"Production\"                       M        30\n17 \"Commodities Transport\"            F         4\n18 \"Commodities Transport\"            M        32\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntb2 |> \n  pivot_wider(id_cols=CATEGORIE, \n              names_from=SEXE, \n              values_from=n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 x 3\n   CATEGORIE                              F     M\n   <fct>                              <int> <int>\n 1 \"Business, Management and Finance\"    23    23\n 2 \"Liberal profession\"                  82    51\n 3 \"Services\"                            75    50\n 4 \"Selling\"                             30    18\n 5 \"Administration\"                      72    22\n 6 \"Agriculture, Fishing, Forestry\"       2     8\n 7 \"Building \"                           NA    36\n 8 \"Repair and maintenance\"              NA    32\n 9 \"Production\"                           9    30\n10 \"Commodities Transport\"                4    32\n```\n\n\n:::\n:::\n\n\n\n\n\n\n:::::\n\n:::\n\n::: {.callout-note title=\"Question\"}\n\nUse `mosaicplot()` from base `R` to visualize the contingency table. \n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmosaicplot(~ CATEGORIE + SEXE, \n           tb, \n           main=\"Données Recensement\")\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/mosaics-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nmosaicplot(~ SEXE + CATEGORIE, tb)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/mosaics-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n::: {.callout-note title=\"Question\"}\n\nUse `geom_mosaic` from `ggmosaic` to visualize the contingency table\n\n- Make the plot as readable as possible\n- Reorder `CATEGORIE` acccording to counts\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrot_x_text <- theme(\n  axis.text.x = element_text(angle = 45)\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot() +\n  geom_mosaic(aes(x=product(SEXE, CATEGORIE), fill=SEXE)) +\n  rot_x_text  \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `scale_name` argument of `continuous_scale()` is deprecated as of ggplot2\n3.5.0.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `trans` argument of `continuous_scale()` is deprecated as of ggplot2 3.5.0.\ni Please use the `transform` argument instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: `unite_()` was deprecated in tidyr 1.2.0.\ni Please use `unite()` instead.\ni The deprecated feature was likely used in the ggmosaic package.\n  Please report the issue at <https://github.com/haleyjeppson/ggmosaic>.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-13-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n:::\n\n:::::\n\n::: {.callout-note title=\"Question\"}\n\n- Collapse rare levels of `CATEGORIE` (consider that a level \nis rare if it has less than 40 occurrences). Use tools from `forcats`. \n\n:::\n  \n::::: {.content-visible when-profile=\"solution\"}  \n  \n::: {.callout-tip title=\"Solution\"}\n \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  count(CATEGORIE) |> \n  arrange(desc(n))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 x 2\n   CATEGORIE                              n\n   <fct>                              <int>\n 1 \"Liberal profession\"                 133\n 2 \"Services\"                           125\n 3 \"Administration\"                      94\n 4 \"Selling\"                             48\n 5 \"Business, Management and Finance\"    46\n 6 \"Production\"                          39\n 7 \"Building \"                           36\n 8 \"Commodities Transport\"               36\n 9 \"Repair and maintenance\"              32\n10 \"Agriculture, Fishing, Forestry\"      10\n```\n\n\n:::\n\n```{.r .cell-code}\nrare_categories <- df |> \n  count(CATEGORIE) |>\n  filter(n<=40)\n\nrare_categories\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 x 2\n  CATEGORIE                            n\n  <fct>                            <int>\n1 \"Agriculture, Fishing, Forestry\"    10\n2 \"Building \"                         36\n3 \"Repair and maintenance\"            32\n4 \"Production\"                        39\n5 \"Commodities Transport\"             36\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df |> \n  mutate(CATEGORIE=fct_lump_min(CATEGORIE, \n                                min=40, \n                                other_level = \"Primary-Secondary\")) \n\ntb <- df |>\n  select(CATEGORIE, SEXE) |> \n  table()\n\ndf |>\n  count(CATEGORIE, SEXE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 x 3\n   CATEGORIE                        SEXE      n\n   <fct>                            <fct> <int>\n 1 Business, Management and Finance F        23\n 2 Business, Management and Finance M        23\n 3 Liberal profession               F        82\n 4 Liberal profession               M        51\n 5 Services                         F        75\n 6 Services                         M        50\n 7 Selling                          F        30\n 8 Selling                          M        18\n 9 Administration                   F        72\n10 Administration                   M        22\n11 Primary-Secondary                F        15\n12 Primary-Secondary                M       138\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmosaicplot(~ CATEGORIE + SEXE, df)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-16-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n:::\n  \n  \n:::::\n\n\n::: {.callout-note title=\"Question\"}\n\nSame as above with `vcd::mosaic`\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvcd::mosaic(formula=SEXE~CATEGORIE,\n            data=table(select(df, CATEGORIE, SEXE)))\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/vcd-mosaic-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n\n\n# Testing association\n\n\n## Chi-square independence/association test \n\n\n[https://statsfonda.github.io/site/content/ch4_2.html#test-dindépendance](https://statsfonda.github.io/site/content/ch4_2.html#test-dindépendance)\n\n\n\n::: {.callout-note title=\"Question\"}\n\n- Compute the chi-square association statistic between `CATEGORIE` and `SEXE`. \n- Display the output of `chisq.test()` as a table, using `broom::tidy()`\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_1 <- df |>\n  select(CATEGORIE, SEXE) |>\n  table() |>\n  chisq.test()\n\n# test_1 \n\ntest_1 |>\n  broom::tidy() |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n| statistic| p.value| parameter|method                     |\n|---------:|-------:|---------:|:--------------------------|\n|  140.6717|       0|         5|Pearson's Chi-squared test |\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n:::\n\n::: {.callout-note title=\"Question\"}\n\nCompute the Chi-square statistics from the contingeny table \n\n:::\n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrowcounts <- apply(tb, MARGIN = 1, FUN = sum)\ncolcounts <- apply(tb, MARGIN = 2, FUN = sum)\n\nexpected <- (rowcounts %*% t(colcounts))/sum(colcounts)\n\n# norm((tb - expected) / sqrt(expected), type = \"F\")^2\n\nexpected |>\n  as_tibble() |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|        F|        M|\n|--------:|--------:|\n| 22.80801| 23.19199|\n| 65.94491| 67.05509|\n| 61.97830| 63.02170|\n| 23.79967| 24.20033|\n| 46.60768| 47.39232|\n| 75.86144| 77.13856|\n\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n# Categorical/Numerical pairs\n\n## Grouped boxplots \n\n::: {.callout-note title=\"Question\"}\n\nPlot boxplots of `AGE` according to `NIV_ETUDES`\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot() +\n  aes(x=NIV_ETUDES, y=AGE) +\n  geom_boxplot() +\n  rot_x_text\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-20-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot() +\n  aes(x=fct_infreq(NIV_ETUDES), y=AGE) +\n  geom_boxplot(varwidth = T) +\n  rot_x_text\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-21-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n:::\n\n:::::\n\n\n::: {.callout-note title=\"Question\"}\n\nDraw density plots of `AGE`, facet by `NIV_ETUDES` and `SEXE`\n\n:::\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- df |> \n  ggplot() +\n  aes(x=AGE) +\n  stat_density(fill=\"white\", color=\"black\") +\n  facet_grid(rows=vars(NIV_ETUDES), \n             cols=vars(SEXE))\n\np\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Groups with fewer than two data points have been dropped.\nGroups with fewer than two data points have been dropped.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in max(ids, na.rm = TRUE): no non-missing arguments to max; returning\n-Inf\nWarning in max(ids, na.rm = TRUE): no non-missing arguments to max; returning\n-Inf\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-22-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n::: {.callout-note title=\"Question\"}\n\nCollapse rare levels of `NIV_ETUDES` and replay.\n\n:::\n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np %+% (\n  df |> \n    mutate(NIV_ETUDES = fct_lump_min(NIV_ETUDES, min=30)) \n)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-23-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n:::\n\n:::::\n\n\n# Numerical/Numerical pairs\n\n## Scatterplots\n\n\n::: {.callout-note title=\"Question\"}\n\nMake a scatterplot of `SAL_HOR`with respect to `AGE`\n\n:::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  ggplot() +\n  aes(x=AGE, y=SAL_HOR, color=SEXE) +\n  geom_point(alpha=.7)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-24-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n:::\n\n\n:::::\n\n\n# Correlations\n\n- Linear correlation coefficient (Pearson)\n- Linear rank correlation coefficient (Spearman $ρ$, Kendall $τ$)\n- $ξ$ rank correlation coefficient (Chatterjee)\n\n## Linear correlation coefficient \n\n::: {.callout-note title=\"Question\"}\n\nCompute the Pearson, Spearman and Kendall correlation coefficients between `AGE` and `SAL_HOR` using \nfunction `cor()` from base `R`\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n\n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  summarise(\n    pearson=cor(AGE, SAL_HOR), \n    spearman=cor(AGE, SAL_HOR, method = \"spearman\"),\n    kendall=cor(AGE, SAL_HOR, method=\"kendall\")) |> \n  gt::gt() |>\n  gt::fmt_number(decimals=2) |>\n  gt::tab_caption(\n    \"Correlation coefficients between SAL_HOR and AGE\\nRecensement dataset\"\n    )\n```\n\n::: {.cell-output-display}\n\\begingroup\n\\fontsize{12.0pt}{14.4pt}\\selectfont\n\\begin{longtable}{rrr}\n\\toprule\npearson & spearman & kendall \\\\ \n\\midrule\\addlinespace[2.5pt]\n0.25 & 0.32 & 0.22 \\\\ \n\\bottomrule\n\\end{longtable}\n\\endgroup\n\n:::\n:::\n\n\n\n\n\n\n\n::: \n\n:::\n\n## Rank based methods \n\nSpearman’s rho (𝜌) and Kendall’s tau (𝜏) are both non-parametric correlation coefficients used to measure the strength and direction of a *monotonic* relationship between two variables. \n\nSpearman’s rho (𝜌)\n: Based on *rank differences*.<br>\nDefined as the *Pearson correlation coefficient* between the *ranked variables*.<br>\n$$\\rho = 1 - \\frac{6 \\sum d_i^2}{n(n^2 - 1)}$$\nwhere $d_i$ is the difference between the ranks of each pair, and $n$ is the number of observations.\n\nKendall’s tau (𝜏)\n: Based on *concordant and discordant pairs*. <br>\nMeasures the *proportion of pairs that have the same order* in both variables compared to the total number of pairs. <br>\n$$\\tau = \\frac{(C - D)}{\\frac{1}{2} n (n - 1)}$$\nwhere $C$ is the number of *concordant pairs*, and $D$ is the number of *discordant pairs*.\n\n\n### When to Use Which?\n\n| Factor | Spearman’s rho (𝜌) | Kendall’s tau (𝜏) |\n|--------|----------------|----------------|\n| Large differences in ranks | More sensitive | Less sensitive |\n| Small sample sizes | Less reliable | More reliable |\n| Outlier resistance | Moderate | High |\n| Computational efficiency | Faster | Slower (due to pairwise comparisons) |\n| Interpretation | Similar to Pearson’s correlation | More intuitive (proportion of concordance) |\n\n\n\n## Chatterjee's correlation coefficient (Chatterjee's $ξ$)\n\n> The three most popular classical measures of statistical association are\nPearson’s correlation coefficient, Spearman’s ρ, and Kendall’s τ . These coefficients are very powerful for detecting linear or monotone associations, and\nthey have well-developed asymptotic theories for calculating P-values. However, the big problem is that they are not effective for detecting associations\nthat are not monotonic, even in the complete absence of noise.\n\n> Let $(X, Y)$ be a pair of random variables, where $Y$ is not a constant.\nLet $(X_1 , Y_1 ), \\ldots, (X_n , Y_n )$ be i.i.d. pairs with the same law as $(X, Y)$, where\n$n ≥ 2$. The new coefficient has a simpler formula if the $X_i$’s and the $Y_i$ ’s\nhave no ties. This simpler formula is presented first, and then the general\ncase is given. Suppose that the $X_i$’s and the $Y_i$ ’s have no ties. Rearrange\nthe data as $(X_{(1)} , Y_{(1)} ), . . . , (X_{(n)} , Y_{(n)} )$ such that $X_{(1)} ≤ · · · ≤ X_{(n)}$ . Since\nthe $X_i$’s have no ties, there is a unique way of doing this. Let ri be the rank\nof $Y_{(i)}$, that is, the number of $j$ such that $Y_{(j)} ≤ Y_{(i)}$. The new correlation\ncoefficient is defined as\n\n$$ξ_n(X, Y ) := 1 −  3\\sum_{i=1}^{n-1} \\frac{|r_{i+1} − r_i|}{n^2-1}$$\n\nIn the presence of ties, $ξ_n$ is defined as follows. If there are ties among the\n$X_i$’s, then choose an increasing rearrangement as above by breaking ties\nuniformly at random. Let $r_i$ be as before, and additionally define $l_i$ to be\nthe number of $j$ such that $Y_{(j)} ≥ Y_{(i)}$. Then define\n\n$$ξ_n(X, Y ) := 1 −  3n\\sum_{i=1}^{n-1} \\frac{|r_{i+1} − r_i|}{2 \\sum_{i=1}^n l_i (n − l_i )}$$\n\nWhen there are no ties among the $Y_i$ ’s, $l_1 , \\ldots , l_n$ is just a permutation of\n$1, \\ldots , n$, and so the denominator in the above expression is just $n(n^2 − 1)/3$,\nwhich reduces this definition to the earlier expression.\n\nFrom [Sourav Chatterjee: A new correlation coefficient](https://arxiv.org/abs/1909.10140)\n\n::: {.callout-note title=\"Question\"}\n\nWrite a `dplyr` pipeline from computing the $ξ$ correlation coefficient between `Y=lifeExp` and `X=gdpPercap`\nin the `gapminder` dataset, per `year` and `continent`. \n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder::gapminder |>  \n  group_by(year, continent) |> \n  arrange(gdpPercap) |> \n  mutate(rnk= row_number(lifeExp), \n         lnk=rank(desc(lifeExp), ties.method = \"max\"), \n         N=n()) |> \n  mutate(fol=lead(rnk), dd=abs(fol-rnk)) |> \n  summarise(Xi=1-n()*sum(dd, na.rm = T)/(2*sum(lnk*(N-lnk), na.rm = T))) |> \n  print(n=50)  \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'year'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 60 x 3\n# Groups:   year [12]\n    year continent       Xi\n   <int> <fct>        <dbl>\n 1  1952 Africa     0.0377 \n 2  1952 Americas   0.135  \n 3  1952 Asia       0.244  \n 4  1952 Europe     0.610  \n 5  1952 Oceania    0      \n 6  1957 Africa     0.0466 \n 7  1957 Americas   0.240  \n 8  1957 Asia       0.330  \n 9  1957 Europe     0.516  \n10  1957 Oceania    0      \n11  1962 Africa    -0.00777\n12  1962 Americas   0.346  \n13  1962 Asia       0.377  \n14  1962 Europe     0.396  \n15  1962 Oceania    0      \n16  1967 Africa     0.0533 \n17  1967 Americas   0.168  \n18  1967 Asia       0.267  \n19  1967 Europe     0.383  \n20  1967 Oceania    0      \n21  1972 Africa     0.238  \n22  1972 Americas   0.188  \n23  1972 Asia       0.324  \n24  1972 Europe     0.316  \n25  1972 Oceania    0      \n26  1977 Africa     0.273  \n27  1977 Americas   0.135  \n28  1977 Asia       0.264  \n29  1977 Europe     0.379  \n30  1977 Oceania    0      \n31  1982 Africa     0.383  \n32  1982 Americas   0.303  \n33  1982 Asia       0.289  \n34  1982 Europe     0.0590 \n35  1982 Oceania    0      \n36  1987 Africa     0.271  \n37  1987 Americas   0.428  \n38  1987 Asia       0.297  \n39  1987 Europe     0.289  \n40  1987 Oceania    0      \n41  1992 Africa     0.363  \n42  1992 Americas   0.524  \n43  1992 Asia       0.429  \n44  1992 Europe     0.393  \n45  1992 Oceania    0      \n46  1997 Africa     0.306  \n47  1997 Americas   0.327  \n48  1997 Asia       0.498  \n49  1997 Europe     0.506  \n50  1997 Oceania    0      \n# i 10 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\n\n:::\n\n# Using package `corrr`\n\n[https://corrr.tidymodels.org](https://corrr.tidymodels.org)\n\n\n::: {.callout-note title=\"Question\"}\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nc <- df |>\n  select(where(is.numeric)) |>\n  corrr::correlate()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCorrelation computed with\n* Method: 'pearson'\n* Missing treated using: 'pairwise.complete.obs'\n```\n\n\n:::\n:::\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nc |>\n  corrr::shave()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 x 3\n  term       AGE SAL_HOR\n  <chr>    <dbl>   <dbl>\n1 AGE     NA          NA\n2 SAL_HOR  0.250      NA\n```\n\n\n:::\n:::\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nc |>\n  corrr::fashion()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     term  AGE SAL_HOR\n1     AGE          .25\n2 SAL_HOR  .25        \n```\n\n\n:::\n:::\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nc |> \n  corrr::shave() |>\n  corrr::rplot()\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-30-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n::: \n \n:::\n\n\n\n# `pairs` from base `R`\n\nJust as function `skim` from package `skimr` allows us to automate univariate analysis,  function `pairs` from base `R` allows us to automate bivariate analysis.\n\n::: {.callout-note title=\"Question\"}\n\n- Apply function `pairs` to the `Recensement` dataset\n- How does `pairs` handle pairs of categorical columns?\n- How does `pairs` handle pairs of numerical columns?\n- How does `pairs` handle categorical/numerical columns?\n- Suggestions for improvements?\n\n:::\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(df)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-31-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n::: \n\n:::\n\n\n# `ggpairs()` from `GGally`\n\n[Documentation](https://www.rdocumentation.org/packages/GGally/versions/2.2.1/topics/ggpairs)\n\n::: {.callout-note title=\"Question\"}\n\n- Apply function `GGally::ggpairs()` to the `Recensement` dataset\n- How does `ggpairs` handle pairs of categorical columns?\n- How does `ggpairs` handle pairs of numerical columns?\n- How does `ggpairs` handle categorical/numerical columns?\n- How does `ggpairs` handle diagonal diagrams? \n- How can you modify layout, labels, ticks? \n- Suggestions for improvements?\n  \n:::\n\n\n::: {.content-visible when-profile='solution'} \n \n::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  select(-REV_FOYER) |>\n  GGally::ggpairs()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRegistered S3 method overwritten by 'GGally':\n  method from   \n  +.gg   ggplot2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-pdf/unnamed-chunk-32-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n::: \n\n:::\n\n# Useful links\n\n- [rmarkdown](bookdown.org/$y_i$hui/rmarkdown)\n- [dplyr](https://gplot2.tidyverse.org)\n- [ggplot2](https://ggplot2.tidyverse.org)\n- *R Graphic Cookbook*. Winston Chang. O' Reilly.\n- [A blog on ggplot object](https://www.data-imaginist.com/2017/Beneath-the-canvas/)\n- [`skimr`]()\n- [`vcd`]()\n- [`ggmosaic`]()\n- [`ggforce`]()\n- [`arrow`]()\n- [`httr`]()\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{booktabs}\n\\usepackage{caption}\n\\usepackage{longtable}\n\\usepackage{colortbl}\n\\usepackage{array}\n\\usepackage{anyfontsize}\n\\usepackage{multirow}\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}