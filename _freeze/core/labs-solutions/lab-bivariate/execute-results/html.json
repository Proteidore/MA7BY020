{
  "hash": "4e0a07fcab30260b2177b6fe495c8808",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Bivariate analysis'\ncategories: [Bivariate analysis, Boxplots, Pairplots]\ndate: \"2025-01-20 23:18:12.797029\"\n\n\nexecute:\n  echo: true\n  eval: true\n  collapse: true\n\n\nformat:\n  html:\n    output-file: lab-bivariate.html\n  pdf:\n    output-file: lab-bivariate.pdf\n\n# params:\n#   truc: html\n#   year: 2024 \n#   curriculum: \"M1 MIDS & MFA\"\n#   university: \"Université Paris Cité\"\n#   homepage: \"https://s-v-b.github.io/MA7BY020\"\n#   moodle: \"https://moodle.u-paris.fr/course/view.php?id=6143\"\n---\n\n\n\n\n::: {layout=\"[80,20]\"}\n\n::: {#first-column}\n\n|                            |\n|:---------------------------|\n| {{< var curriculum >}}     |\n| {{< var university >}}     |\n| Année {{< var year >}}     |\n| {{< var homepage >}}       |\n| {{< var moodle >}}         |\n\n\n::: \n\n::: {#second-column}\n![](/images/UniversiteParis_monogramme_couleur_RVB.png){align=\"right\" style=\"size:50px;\" width=75}\n:::\n\n:::\n\n\n\n\n::: {.callout-important}\n\n### Objectives\n\nIn Exploratory analysis of tabular data, bivariate analysis is the second step. It consists in exploring, summarizing, visualizing pairs of columns of a dataset.\n\n:::\n\n\n## Setup\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstopifnot(\n  require(tidyverse), \n  require(glue),\n  require(magrittr),\n  require(lobstr),\n  require(arrow),\n  require(ggforce),\n  require(vcd),\n  require(ggmosaic),\n  require(httr),\n  require(patchwork)\n)\n```\n:::\n\n\n\n\n\n\nBivariate techniques depend on the types of columns we are facing.\n\n\nFor *numerical/numerical* samples \n\n- Scatter plots\n- Smoothed lineplots (for example linear regression)\n- 2-dimensional density plots\n\nFor *categorical/categorical* samples : mosaicplots and variants\n\nFor *numerical/categorical* samples\n\n- Boxplots per group\n- Histograms per group\n- Density plots per group\n- Quantile-Quantile plots\n\n\n# Dataset\n\nOnce again we rely on the Census dataset.\n\n> Since 1948, the US Census Bureau  carries out a monthly Current Population Survey,  collecting data concerning residents aged above 15  from $150 000$ households.  This survey is one of the most important sources of information concerning the american workforce. Data reported in file `Recensement.txt`  originate from the 2012 census. \n\nLoad the data into the session environment and call it `df`. Take advantage \nof the fact that we saved the result of our data wrangling job in a self-documented file format. Download a `parquet` file from the following URL: \n\n`https://stephane-v-boucheron.fr/data/Recensement.parquet`\n\n::: {.callout-tip}\n\nUse `httr::GET()` and `WriteBin()`. \n\n:::\n\n::: {.content-visible when-profile=\"solution\"}\n\n::::: {.callout-note title=\"Solution\" collapse=\"true\"}\n\n\n\n\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfname <- \"Recensement.parquet\"\n\nfpath <- paste(datapath, fname, sep=\"/\")\n\nif (!file.exists(fpath)) {\n  tryCatch(expr = { \n    url <- 'https://stephane-v-boucheron.fr/data/Recensement.parquet'\n\n    rep <- httr::GET(url)\n    stopifnot(rep$status_code==200)\n    \n    con <- file(fpath, open=\"wb\")\n    writeBin(rep$content, con)\n    close(con)\n  }, warning = function(w) {\n    glue(\"Successful download but {w}\")\n  }, error = function(e) {\n    stop(\"Houston, we have a problem!\")    # error-handler-code\n  }, finally = {\n    if (exists(\"con\") && isOpen(con)){\n      close(con)\n    }\n  } \n  )\n} \n\ndf <- arrow::read_parquet(fpath)\n```\n:::\n\n::: {.cell mesage='false'}\n\n```{.r .cell-code}\ndf |>\n  glimpse()\n## Rows: 599\n## Columns: 11\n## $ AGE        <dbl> 58, 40, 29, 59, 51, 19, 64, 23, 47, 66, 26, 23, 54, 44, 56,…\n## $ SEXE       <fct> F, M, M, M, M, M, F, F, M, F, M, F, F, F, F, F, F, M, M, F,…\n## $ REGION     <fct> NE, W, S, NE, W, NW, S, NE, NW, S, NE, NE, W, NW, S, S, NW,…\n## $ STAT_MARI  <fct> C, M, C, D, M, C, M, C, M, D, M, C, M, C, M, C, S, M, S, C,…\n## $ SAL_HOR    <dbl> 13.25, 12.50, 14.00, 10.60, 13.00, 7.00, 19.57, 13.00, 20.1…\n## $ SYNDICAT   <fct> non, non, non, oui, non, non, non, non, oui, non, non, non,…\n## $ CATEGORIE  <fct> \"Administration\", \"Building \", \"Administration\", \"Services\"…\n## $ NIV_ETUDES <fct> \"Bachelor\", \"12 years schooling, no diploma\", \"Associate de…\n## $ NB_PERS    <fct> 2, 2, 2, 4, 8, 6, 3, 2, 3, 1, 3, 2, 6, 5, 4, 4, 3, 2, 3, 2,…\n## $ NB_ENF     <fct> 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,…\n## $ REV_FOYER  <fct> [35000-40000), [17500-20000), [75000-1e+05), [17500-20000),…\n\ndf |>\n  head()\n## # A tibble: 6 × 11\n##     AGE SEXE  REGION STAT_MARI SAL_HOR SYNDICAT CATEGORIE     NIV_ETUDES NB_PERS\n##   <dbl> <fct> <fct>  <fct>       <dbl> <fct>    <fct>         <fct>      <fct>  \n## 1    58 F     NE     C            13.2 non      \"Administrat… Bachelor   2      \n## 2    40 M     W      M            12.5 non      \"Building \"   12 years … 2      \n## 3    29 M     S      C            14   non      \"Administrat… Associate… 2      \n## 4    59 M     NE     D            10.6 oui      \"Services\"    12 years … 4      \n## 5    51 M     W      M            13   non      \"Services\"    9 years s… 8      \n## 6    19 M     NW     C             7   non      \"Services\"    12 years … 6      \n## # ℹ 2 more variables: NB_ENF <fct>, REV_FOYER <fct>\n```\n:::\n\n\n\n\n:::::\n\n:::\n\n# Categorical/Categorical pairs\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  select(where(is.factor)) |>\n  head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 9\n  SEXE  REGION STAT_MARI SYNDICAT CATEGORIE  NIV_ETUDES NB_PERS NB_ENF REV_FOYER\n  <fct> <fct>  <fct>     <fct>    <fct>      <fct>      <fct>   <fct>  <fct>    \n1 F     NE     C         non      \"Administ… Bachelor   2       0      [35000-4…\n2 M     W      M         non      \"Building… 12 years … 2       0      [17500-2…\n3 M     S      C         non      \"Administ… Associate… 2       0      [75000-1…\n4 M     NE     D         oui      \"Services\" 12 years … 4       1      [17500-2…\n5 M     W      M         non      \"Services\" 9 years s… 8       1      [75000-1…\n6 M     NW     C         non      \"Services\" 12 years … 6       0      [1e+05-1…\n```\n\n\n:::\n:::\n\n\n\n\nExplore the connection between `CATEGORIE` and `SEX`. \nCompute the 2-ways contingency table using `table()`, and  `count()` from `dplyr`. \n\nUse `tibble::as_tibble()` to transform the output of `table()` into a dataframe/tibble.\n\nUse `tidyr::pivot_wider()` so as to obtain a wide (but messy) tibble with the same the same shape as the output of `table()`. Can you spot a difference? \n\n::: {.content-visible when-profile=\"solution\"}  \n\n::::: {.callout-tip title=\"Solution\"}\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntb <- df |>\n  dplyr::select(CATEGORIE, SEXE) |>\n  table() \n\n# tb\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntb2 <- df |>\n  count(CATEGORIE, SEXE)\n\ntb2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 18 × 3\n   CATEGORIE                          SEXE      n\n   <fct>                              <fct> <int>\n 1 \"Business, Management and Finance\" F        23\n 2 \"Business, Management and Finance\" M        23\n 3 \"Liberal profession\"               F        82\n 4 \"Liberal profession\"               M        51\n 5 \"Services\"                         F        75\n 6 \"Services\"                         M        50\n 7 \"Selling\"                          F        30\n 8 \"Selling\"                          M        18\n 9 \"Administration\"                   F        72\n10 \"Administration\"                   M        22\n11 \"Agriculture, Fishing, Forestry\"   F         2\n12 \"Agriculture, Fishing, Forestry\"   M         8\n13 \"Building \"                        M        36\n14 \"Repair and maintenance\"           M        32\n15 \"Production\"                       F         9\n16 \"Production\"                       M        30\n17 \"Commodities Transport\"            F         4\n18 \"Commodities Transport\"            M        32\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntb2 |> \n  pivot_wider(id_cols=CATEGORIE, \n              names_from=SEXE, \n              values_from=n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 3\n   CATEGORIE                              F     M\n   <fct>                              <int> <int>\n 1 \"Business, Management and Finance\"    23    23\n 2 \"Liberal profession\"                  82    51\n 3 \"Services\"                            75    50\n 4 \"Selling\"                             30    18\n 5 \"Administration\"                      72    22\n 6 \"Agriculture, Fishing, Forestry\"       2     8\n 7 \"Building \"                           NA    36\n 8 \"Repair and maintenance\"              NA    32\n 9 \"Production\"                           9    30\n10 \"Commodities Transport\"                4    32\n```\n\n\n:::\n:::\n\n\n\n\n:::::\n\n:::\n\nUse `mosaicplot()` from base `R` to visualize the contingency table. \n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmosaicplot(~ CATEGORIE + SEXE, \n           tb, \n           main=\"Données Recensement\")\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nmosaicplot(~ SEXE + CATEGORIE, tb)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n:::::\n\nUse `geom_mosaic` from `ggmosaic` to visualize the contingency table\n\n- Make the plot as readable as possible\n- Reorder `CATEGORIE` acccording to counts\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrot_x_text <- theme(\n  axis.text.x = element_text(angle = 45)\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot() +\n  geom_mosaic(aes(x=product(SEXE, CATEGORIE), fill=SEXE)) +\n  rot_x_text  \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `scale_name` argument of `continuous_scale()` is deprecated as of ggplot2\n3.5.0.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `trans` argument of `continuous_scale()` is deprecated as of ggplot2 3.5.0.\nℹ Please use the `transform` argument instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: `unite_()` was deprecated in tidyr 1.2.0.\nℹ Please use `unite()` instead.\nℹ The deprecated feature was likely used in the ggmosaic package.\n  Please report the issue at <https://github.com/haleyjeppson/ggmosaic>.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::\n\n:::::\n\n- Collapse rare levels of `CATEGORIE` (consider that a level \nis rare if it has less than 40 occurrences). Use tools from `forcats`. \n  \n::::: {.content-visible when-profile=\"solution\"}  \n  \n::: {.callout-tip title=\"Solution\"}\n \n \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  count(CATEGORIE) |> \n  arrange(desc(n))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n   CATEGORIE                              n\n   <fct>                              <int>\n 1 \"Liberal profession\"                 133\n 2 \"Services\"                           125\n 3 \"Administration\"                      94\n 4 \"Selling\"                             48\n 5 \"Business, Management and Finance\"    46\n 6 \"Production\"                          39\n 7 \"Building \"                           36\n 8 \"Commodities Transport\"               36\n 9 \"Repair and maintenance\"              32\n10 \"Agriculture, Fishing, Forestry\"      10\n```\n\n\n:::\n\n```{.r .cell-code}\nrare_categories <- df |> \n  count(CATEGORIE) |>\n  filter(n<=40)\n\nrare_categories\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  CATEGORIE                            n\n  <fct>                            <int>\n1 \"Agriculture, Fishing, Forestry\"    10\n2 \"Building \"                         36\n3 \"Repair and maintenance\"            32\n4 \"Production\"                        39\n5 \"Commodities Transport\"             36\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df |> \n  mutate(CATEGORIE=fct_lump_min(CATEGORIE, \n                                min=40, \n                                other_level = \"Primary-Secondary\")) \n\ntb <- df |>\n  select(CATEGORIE, SEXE) |> \n  table()\n\ndf |>\n  count(CATEGORIE, SEXE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 3\n   CATEGORIE                        SEXE      n\n   <fct>                            <fct> <int>\n 1 Business, Management and Finance F        23\n 2 Business, Management and Finance M        23\n 3 Liberal profession               F        82\n 4 Liberal profession               M        51\n 5 Services                         F        75\n 6 Services                         M        50\n 7 Selling                          F        30\n 8 Selling                          M        18\n 9 Administration                   F        72\n10 Administration                   M        22\n11 Primary-Secondary                F        15\n12 Primary-Secondary                M       138\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmosaicplot(~ CATEGORIE + SEXE, df)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::\n  \n  \n:::::\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvcd::mosaic(formula=SEXE~CATEGORIE,\n            data=table(select(df, CATEGORIE, SEXE)))\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n:::::\n\n# Testing association\n\n\n## Chi-square independence/association test \n\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_1 <- df |>\n  select(CATEGORIE, SEXE) |>\n  table() |>\n  chisq.test()\n\n# test_1 \n\ntest_1 |>\n  broom::tidy() |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n| statistic| p.value| parameter|method                     |\n|---------:|-------:|---------:|:--------------------------|\n|  140.6717|       0|         5|Pearson's Chi-squared test |\n\n\n:::\n:::\n\n\n\n\n\n\n:::\n\nThe Chi-square statistics can be computed from the contingeny table \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrowcounts <- apply(tb, MARGIN = 1, FUN = sum)\ncolcounts <- apply(tb, MARGIN = 2, FUN = sum)\n\nexpected <- (rowcounts %*% t(colcounts))/sum(colcounts)\n\n# norm((tb - expected) / sqrt(expected), type = \"F\")^2\n\nexpected |>\n  as_tibble() |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|        F|        M|\n|--------:|--------:|\n| 22.80801| 23.19199|\n| 65.94491| 67.05509|\n| 61.97830| 63.02170|\n| 23.79967| 24.20033|\n| 46.60768| 47.39232|\n| 75.86144| 77.13856|\n\n\n:::\n:::\n\n\n\n\n:::\n\n:::::\n\n\n# Categorical/Numerical pairs\n\n## Grouped boxplots \n\nPlot boxplots of `AGE` according to `NIV_ETUDES`\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot() +\n  aes(x=NIV_ETUDES, y=AGE) +\n  geom_boxplot() +\n  rot_x_text\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot() +\n  aes(x=fct_infreq(NIV_ETUDES), y=AGE) +\n  geom_boxplot(varwidth = T) +\n  rot_x_text\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n:::\n\n:::::\n\nDraw density plots of `AGE`, facet by `NIV_ETUDES` and `SEXE`\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- df |> \n  ggplot() +\n  aes(x=AGE) +\n  stat_density(fill=\"white\", color=\"black\") +\n  facet_grid(rows=vars(NIV_ETUDES), \n             cols=vars(SEXE))\n\np\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Groups with fewer than two data points have been dropped.\nGroups with fewer than two data points have been dropped.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in max(ids, na.rm = TRUE): no non-missing arguments to max; returning\n-Inf\nWarning in max(ids, na.rm = TRUE): no non-missing arguments to max; returning\n-Inf\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n:::::\n\nCollapse rare levels of `NIV_ETUDES` and replay.\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np %+% (df |> \n  mutate(NIV_ETUDES = fct_lump_min(NIV_ETUDES, min=30)) )\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n:::\n\n:::::\n\n\n# Numerical/Numerical pairs\n\n## Scatterplots\n\nMake a scatterplot of `SAL_HOR`with respect to `AGE`\n\n::::: {.content-visible when-profile=\"solution\"}  \n\n::: {.callout-tip}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  ggplot() +\n  aes(x=AGE, y=SAL_HOR, color=SEXE) +\n  geom_point(alpha=.7)\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::\n\n\n:::::\n\n\n## Correlations\n\n- Linear correlation coefficient (Pearson $\\rho$)\n- Linear rank correlation coefficient (Spearman, Kendall)\n- $\\xi$ rank correlation coefficient (Chatterjee)\n\n\n# `pairs` from base `R`\n\n\n# `ggpairs()`\n\n# Useful links\n\n- [rmarkdown](bookdown.org/yihui/rmarkdown)\n- [dplyr](https://gplot2.tidyverse.org)\n- [ggplot2](https://ggplot2.tidyverse.org)\n- *R Graphic Cookbook*. Winston Chang. O' Reilly.\n- [A blog on ggplot object](https://www.data-imaginist.com/2017/Beneath-the-canvas/)\n- [`skimr`]()\n- [`vcd`]()\n- [`ggmosaic`]()\n- [`ggforce`]()\n- [`arrow`]()\n- [`httr`]()\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpand.grid(levels(df$CATEGORIE), levels(df$SEXE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                               Var1 Var2\n1  Business, Management and Finance    F\n2                Liberal profession    F\n3                          Services    F\n4                           Selling    F\n5                    Administration    F\n6                 Primary-Secondary    F\n7  Business, Management and Finance    M\n8                Liberal profession    M\n9                          Services    M\n10                          Selling    M\n11                   Administration    M\n12                Primary-Secondary    M\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |> \n  select(CATEGORIE, SEXE) |> \n  table() |> \n  mosaicplot()\n```\n\n::: {.cell-output-display}\n![](lab-bivariate_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npchisq(140, df=5, lower.tail = F)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.789245e-28\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}